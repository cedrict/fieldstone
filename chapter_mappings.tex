\chapter{Mapping \& Jacobians} \label{ss:mappings} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{flushright} {\tiny {\color{gray} chapter\_mappings.tex}} \end{flushright}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

\index{general}{Isoparametric}
\index{general}{Subparametric} 
\index{general}{Superparametric}

The name {\sl isoparametric} derives from the fact that the same ('iso') 
functions are used as basis functions and for the mapping to the reference element.

More generally, if $n_e$ denotes the number of nodes of an element and $n_g$ denotes the 
number of nodes describing the geometry of the element, 
then the element is termed {\sl subparametric} when $n_g<n_e$ and 
{\sl superparametric} when $n_g>n_e$.

%==============================================================================
\section{General case}

What follows is written for the 2d case but extending it to 3d is trivial.

Any variable defined on the element can be approximated using the basis functions:
\begin{equation}
f^h(r,s)=\sum_i \bN_i(r,s) f_i.
\end{equation}
If we treat the coordinate variables $x$ and $y$ themselves as functions of $(r,s)$, 
then the basis functions can be used to construct the mapping:
\begin{eqnarray}
x(r,s) &=& \sum_{i=1}^4 \bN_i(r,s) x_i \\
y(r,s) &=& \sum_{i=1}^4 \bN_i(r,s) y_i 
\end{eqnarray}
This is a relationship between the reduced coordinates $r,s$ and the 'real'
coordinates $x,y$.

Let us compute the space derivatives of these quantities:
\begin{eqnarray}
\frac{\partial x}{\partial r} &=& \sum_i \frac{\partial \bN_i}{\partial r} x_i \nn\\
\frac{\partial x}{\partial s} &=& \sum_i \frac{\partial \bN_i}{\partial s} x_i \nn\\
\frac{\partial y}{\partial r} &=& \sum_i \frac{\partial \bN_i}{\partial r} y_i \nn\\
\frac{\partial y}{\partial s} &=& \sum_i \frac{\partial \bN_i}{\partial s} y_i \nn
\end{eqnarray}

We also have 
\begin{eqnarray}
\frac{\partial f}{\partial r} &=&
\frac{\partial f}{\partial x}\frac{\partial x}{\partial r}
+\frac{\partial f}{\partial y}\frac{\partial y}{\partial r} \\
\frac{\partial f}{\partial s} &=&
\frac{\partial f}{\partial x}\frac{\partial x}{\partial s}
+\frac{\partial f}{\partial y}\frac{\partial y}{\partial s}
\end{eqnarray}
or in matrix form:
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial f}{\partial r} \\ \\
\frac{\partial f}{\partial s}
\end{array}
\right)
=
\underbrace{
\left(
\begin{array}{cc}
\frac{\partial x}{\partial r} & \frac{\partial y}{\partial r} \nonumber\\ \\
\frac{\partial x}{\partial s} & \frac{\partial y}{\partial s} \nonumber
\end{array}
\right)
}_{\bm J}
\cdot
\left(
\begin{array}{c}
\frac{\partial f}{\partial x} \\ \\
\frac{\partial f}{\partial y}
\end{array}
\right)
\end{equation}
where ${\bm J}$ is called the Jacobian of the transformation.
By inverting the Jacobian matrix, the desired derivatives with respect to $x$
and $y$ can be obtained:
\[
\left(
\begin{array}{c}
\frac{\partial f}{\partial x} \\ \\
\frac{\partial f}{\partial y}
\end{array}
\right)
=
{\bm J}^{-1} \cdot 
\left(
\begin{array}{c}
\frac{\partial f}{\partial r} \\ \\
\frac{\partial f}{\partial s}
\end{array}
\right)
\]
The inverse of the Jacobian matrix can be simply obtained in 
2d (Cramer's rule for $2\times2$ matrices\footnote{\url{https://en.wikipedia.org/wiki/Cramers_rule}}):
\[
{\bm J}^{-1} = \frac{1}{|{\bm J}|} 
\left(
\begin{array}{cc}
\frac{\partial y}{\partial s} & -\frac{\partial y}{\partial r} \nonumber\\ \\
-\frac{\partial x}{\partial s} & \frac{\partial x}{\partial r} \nonumber
\end{array}
\right)
\]
The presence of the determinant in the denominator implies that it cannot 
be zero anywhere, or in other words: the mapping is not valid if $|{\bm J}|$
is zero anywhere over the element.


\begin{remark}
Problems also arise when the Jacobian matrix is nearly singular due to round-off errors.
To avoid problems linked to badly shaped elements, it is recommended that the inside
angles of an element are larger than $15\degree$ and less than $165\degree$.
\end{remark}

Since $x(r,s)$ and $y(r,s)$, we can also write:
\begin{eqnarray}
dx &=& \frac{\partial x}{\partial r} dr + \frac{\partial x}{\partial s} ds \nn\\
dy &=& \frac{\partial y}{\partial r} dr + \frac{\partial y}{\partial s} ds \nn
\end{eqnarray}
and we see that the Jocobian matrix also appears so that 
\begin{equation}
\left(
\begin{array}{c}
dx \\ dy
\end{array}
\right)
={\bm J}\cdot
\left(
\begin{array}{c}
dr \\ ds
\end{array}
\right)
\end{equation}
This means that integrating over the 'real' element in $(x,y)$ space
can be simply done by integrating of the reference element in the 
$(r,s)$ space\footnote{\url{https://en.wikibooks.org/wiki/Calculus/Change_of_variables}}. 
This is the cornerstone of most of the implementation of the 
Finite Element Method, the second integral being carried out by means 
of the Gauss-Legendre quadrature.

\begin{equation}
\iint_{\Omega_e} ... \; dx dy = \int_{-1}^{+1} \int_{-1}^{+1} ...|{\bm J}| \; dr ds
\end{equation}




%==============================================================================
\section{Linear mapping on a triangle}

\begin{eqnarray}
x(r,s) 
&=& \sum_{i=1}^3 \bN_i(r,s) x_i \nonumber\\
&=& \bN_1(r,s) x_1 +\bN_2(r,s) x_2 +\bN_3(r,s) x_3   \nonumber\\
&=&  (1-r-s) x_1 +(r) x_2  +(s) x_3   \nonumber\\
&=& x_1 + (x_2-x_1) r + (x_3-x_1)s \nonumber\\
&=& a_x + b_x r + c_x s \nn\\
y 
&=& \sum_{i=1}^3 \bN_i(r,s) y_i \nonumber\\
&=& \bN_1(r,s) y_1 +\bN_2(r,s) y_2 +\bN_3(r,s) y_3   \nonumber\\
&=&  (1-r-s) y_1 +(r) y_2  +(s) y_3   \nonumber\\
&=& y_1 + (y_2-y_1) r + (y_3-y_1)s \nonumber\\
&=& a_y+ b_y r + c_y s \nn 
\end{eqnarray}

Let us compute the space derivatives of these quantities:
\begin{eqnarray}
\frac{\partial x}{\partial r} &=& x_2-x_1=b_x \nonumber\\
\frac{\partial x}{\partial s} &=& x_3-x_1=c_x \nonumber\\
\frac{\partial y}{\partial r} &=& y_2-y_1=b_y \nonumber\\
\frac{\partial y}{\partial s} &=& y_3-y_1=c_y \nonumber
\end{eqnarray}
The jacobian matrix is then given by
\[
{\bm J} = \left(
\begin{array}{cc}
x_2-x_1 & y_2-y_1 \\
x_3-x_1 & y_3-y_1
\end{array}
\right)
= \left(
\begin{array}{cc}
b_x & b_y \\
c_x & c_y
\end{array}
\right)
\]
and its inverse
\[
{\bm J}^{-1} 
= \frac{1}{b_xc_y-c_xb_y}
\left(
\begin{array}{cc}
c_y& -b_y \\
-c_x & b_x
\end{array}
\right)
=
\frac{1}{2A}
\left(
\begin{array}{cc}
c_y& -b_y \\
-c_x & b_x
\end{array}
\right)
\]
where $A=(b_xc_y-c_xb_y)/2$ is actually the area of the triangle!


The Cartesian basis function derivatives are then
\begin{eqnarray}
\left(\begin{array}{c}
\frac{\partial \bN_1}{\partial x} \\ \\
\frac{\partial \bN_1}{\partial y}
\end{array}\right)
&=&
{\bm J}^{-1}
\cdot
\left(\begin{array}{c}
\frac{\partial \bN_1}{\partial r} \\ \\
\frac{\partial \bN_1}{\partial s}
\end{array}\right)
=
\frac{1}{2A}
\left(\begin{array}{cc}
c_y& -b_y \\
-c_x & b_x
\end{array}\right)
\cdot
\left(\begin{array}{c} -1 \\ \\ -1  \end{array}\right)
=
\frac{1}{2A} 
\left(\begin{array}{c} b_y - c_y \\  c_x - b_x \end{array}\right)
\nn\\
\left(\begin{array}{c}
\frac{\partial \bN_2}{\partial x} \\ \\
\frac{\partial \bN_2}{\partial y}
\end{array}\right)
&=&
{\bm J}^{-1}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_2}{\partial r} \\ \\
\frac{\partial \bN_2}{\partial s}
\end{array}
\right)
=
\frac{1}{2A}
\left(\begin{array}{cc}
c_y& -b_y \\
-c_x & b_x
\end{array}\right)
\cdot
\left(\begin{array}{c} 1 \\ 0 \end{array}\right)
=
\frac{1}{2A} 
\left(\begin{array}{c} c_y \\ -c_x \end{array}\right)
\nn\\
\left(\begin{array}{c}
\frac{\partial \bN_3}{\partial x} \\ \\
\frac{\partial \bN_3}{\partial y}
\end{array}\right)
&=&
{\bm J}^{-1}
\cdot
\left(\begin{array}{c}
\frac{\partial \bN_3}{\partial r} \\ \\
\frac{\partial \bN_3}{\partial s}
\end{array}\right)
=
\frac{1}{2A}
\left(\begin{array}{cc}
c_y& -b_y \\
-c_x & b_x
\end{array}\right)
\cdot
\left(\begin{array}{c} 0 \\ 1  \end{array}\right)
=
\frac{1}{2A} 
\left(\begin{array}{c} -b_y \\  b_x \end{array}\right) \nn
\end{eqnarray}

In the end this means that if a field $\phi$ is known at the vertices
of the triangle (with values $\phi_{0,1,2}$) its value anywhere
in the triangle is given by
\[
\phi^h(x,y) = \sum_i \bN_i(r(x,y),s(x,y)) \phi_i
\]
and its gradient by
\[
\nabla^h \phi (x,y) = \sum_i 
\left(
\begin{array}{c}
\sum_i \frac{\partial \bN_i}{\partial x} \phi_i \\
\sum_i \frac{\partial \bN_i}{\partial y} \phi_i 
\end{array}
\right)
\]
where we must note that the gradient is in fact constant over the 
whole triangle (it does not depend on $x,y$).


%==============================================================================
\section{Bilinear mapping ($Q_1$) on a quadrilateral}

The \index{general}{reference element} reference element 
is in the $(r,s)$ space. It is a square of size $2\times2$ 
centered around the origin, i.e. $(r,s)\in[-1,1]\times[-1,1]$. 
We wish to map it to the quadrilateral in the $(x,y)$ space 
(and vice versa):

\begin{center}
\includegraphics[width=8cm]{images/mappings/bilinear/mapping_bilinear.png}
\end{center}

By convention we call {\it forward mapping} the mapping from $(r,s)$
to $(x,y)$.

The coordinates of the vertices are 
$(x_1,y_1)$, $(x_2,y_2)$, $(x_3,y_3)$ and $(x_4,y_4)$.
We then simply have the 
following relationship, i.e. any point of the reference element 
can be mapped to the physical quadrilateral as follows:
\begin{eqnarray}
x&=& \bN_1(r,s) x_1 + \bN_2(r,s) x_2 + \bN_3(r,s) x_3 + \bN_4(r,s) x_4 \nn\\
y&=& \bN_1(r,s) y_1 + \bN_2(r,s) y_2 + \bN_3(r,s) y_3 + \bN_4(r,s) y_4 \label{mapppQ1a} 
\end{eqnarray} 
where the $Q_1$ basis functions $\bN_i(r,s)$ are defined in Section~\ref{sec:elts1D}.

In the following example the program randomly generates 10000 points 
inside the reference 
element and computes their mapping into the $(x,y)$ space. 

\begin{lstlisting}
x1=-1 ; y1=-2
x2=3  ; y2=-1
x3=2  ; y3=2
x4=-3 ; y4=1

npts=10000
r=np.zeros(npts,dtype=np.float64)   
s=np.zeros(npts,dtype=np.float64)   
x=np.zeros(npts,dtype=np.float64)   
y=np.zeros(npts,dtype=np.float64)   

for i in range(0,npts):
    # compute random r,s coordinates
    r[i]=random.uniform(-1.,+1)
    s[i]=random.uniform(-1.,+1)
    # compute basis function values at r,s
    N1=0.25*(1-r[i])*(1-s[i])
    N2=0.25*(1+r[i])*(1-s[i])
    N3=0.25*(1+r[i])*(1+s[i])
    N4=0.25*(1-r[i])*(1+s[i])
    # compute x,y coordinates
    x[i]=N1*x1+N2*x2+N3*x3+N4*x4
    y[i]=N1*y1+N2*y2+N3*y3+N4*y4

np.savetxt('rs.ascii',np.array([r,s]).T)
np.savetxt('xy.ascii',np.array([x,y]).T)
\end{lstlisting}

\begin{center}
\includegraphics[width=8cm]{images/mappings/bilinear/rs.pdf}
\includegraphics[width=8cm]{images/mappings/bilinear/xy.pdf}
\end{center}

There is also an inverse map, which is not so easily computed (see Section~\ref{sec:amiin}).
However, if the quadrilateral in the $(x,y)$ space is a rectangle of size $(h_x,h_y)$, 
the inverse mapping is trivial:
\begin{eqnarray}
r&=&\frac{x-x_1}{x_2-x_1} \\
s&=&\frac{y-y_1}{y_4-y_1} 
\end{eqnarray}
Also in the case of rectangular elements of size $(h_x,h_y)$
the basis functions can directly be written as functions of the $(x,y)$ coordinates:
\begin{eqnarray}
\bN_1(x,y) &=& \left( \frac{x_3 -x }{h_x}  \right) \left( \frac{y_3 -y }{h_y}  \right) \nn\\
\bN_2(x,y) &=& \left( \frac{x - x_1}{h_x}  \right) \left( \frac{y_3 -y }{h_y}  \right) \nn\\
\bN_3(x,y) &=& \left( \frac{x - x_1}{h_x}  \right) \left( \frac{y - y_1}{h_y}  \right) \nn\\
\bN_4(x,y) &=& \left( \frac{x_3 -x }{h_x}  \right) \left( \frac{y - y_1}{h_y}  \right) \nn 
\end{eqnarray}
From Eq.~\eqref{mapppQ1a} and using the expressions for the $Q_1$ basis functions, we can write 
\begin{eqnarray}
x &=& 
 \frac14(x_1+ x_2+ x_3 +x_4) 
+\frac14(-x_1 +x_2 +x_3 -x_4) r 
+\frac14(-x_1 -x_2 +x_3 +x_4) s
+\frac14(x_1 -x_2 +x_3 -x_4) rs \nonumber\\
y &=& 
 \frac14(y_1+ y_2+ y_3 +y_4) 
+\frac14(-y_1 +y_2 +y_3 -y_4) r 
+\frac14(-y_1 -y_2 +y_3 +y_4) s
+\frac14(y_1 -y_2 +y_3 -y_4) rs \nonumber
\end{eqnarray}

Let us compute the space derivatives of these quantities:
\begin{eqnarray}
\frac{\partial x}{\partial r} &=& \frac14(-x_1 +x_2 +x_3 -x_4) +\frac14(x_1 -x_2 +x_3 -x_4) s = A_1 + A_2s\nonumber\\
\frac{\partial x}{\partial s} &=& \frac14(-x_1 -x_2 +x_3 +x_4) +\frac14(x_1 -x_2 +x_3 -x_4) r = A_3 + A_4r\nonumber\\
\frac{\partial y}{\partial r} &=& \frac14(-y_1 +y_2 +y_3 -y_4) +\frac14(y_1 -y_2 +y_3 -y_4) s = B_1 + B_2s\nonumber\\
\frac{\partial y}{\partial s} &=& \frac14(-y_1 -y_2 +y_3 +y_4) +\frac14(y_1 -y_2 +y_3 -y_4) r = B_3 + B_4r \nonumber
\end{eqnarray}
The jacobian matrix is then given by
\[
{\bm J} = \left(
\begin{array}{cc}
A_1 + A_2s & B_1 + B_2s \\
A_3 + A_4r & B_3 + B_4r
\end{array}
\right)
\]
and its inverse
\[
{\bm J}^{-1} = \frac{1}{C}
\left(
\begin{array}{cc}
B_3 + B_4r & -B_1 - B_2s \\
-A_3 - A_4r & A_1 + A_2s
\end{array}
\right)
\]
with $C$ being the determinant given by
\[
C= (A_1 + A_2s)(B_3 + B_4r)-(A_3 + A_4r)(B_1 + B_2s)
\]


%---------------------------------
\subsection{A concrete example}

Let us look at this by means of a simple example and let us consider the following 
element:
\begin{center}
\includegraphics[width=4cm]{images/mappings/fournode/ex1}
\end{center}
Then a $Q_1$ mapping yields:
\begin{eqnarray}
x(r,s) &=& \sum_i \bN_i(r,s) x_i = \bN_2 + 2\bN_3 = \frac{1}{4} (3+3r+ s+rt) \nn\\
y(r,s) &=& \sum_i \bN_i(r,s) y_i = 2\bN_3 + \bN_4 = \frac{1}{4} (3+r+ 3s+rt) 
\end{eqnarray}
The Jacobian matrix is then
\begin{equation}
{\bm J} = 
\left(
\begin{array}{cc}
\frac{\partial x}{\partial r} & \frac{\partial y}{\partial r} \nonumber\\ \\
\frac{\partial x}{\partial s} & \frac{\partial y}{\partial s} \nonumber
\end{array}
\right)
=
\frac{1}{4}
\left(
\begin{array}{cc}
3+s & 1+s \\
1+r & 3+r
\end{array}
\right)
\end{equation}
and its determinant is 
\begin{equation}
|{\bm J}|=\frac{1}{4} [(3+s)(3+r)-(1+s)(1+r)]=\frac{1}{2}+\frac{1}{8}r+\frac{1}{8}s
\end{equation}
It is clear that $|{\bm J}|>0$ for $-1\leq r \leq +1$ and $-1\leq s \leq +1$ so that 
forward and inverse mappings exist and are unique. 

Let us now consider another example, the following element:
\begin{center}
\includegraphics[width=3.5cm]{images/mappings/fournode/ex2}
\end{center}
It follows that
\begin{eqnarray}
x(r,s) &=& \sum_i \bN_i(r,s) x_i = \frac{1}{4}(1+r)(7+5s) \\ 
y(r,s) &=& \sum_i \bN_i(r,s) y_i = \frac{1}{4}(17+5r+7s-5rs)
\end{eqnarray}
and the determinant:
\[
|{\bm J}|=\frac{3}{2}-\frac{15r}{4}+\frac{15s}{4}
\]
is zero for $r-s=2/5$. This mapping is invalid!



%.............................................................................
\subsection{the special case of squares, quadrilaterals and parallelograms}

In this case the parameters $A_2$, $A_4$, $B_2$, $B_4$ are all equal to zero.
We can convince ourselves that it is indeed the case
by drawing these quadrilaterals and computing 
these quantities.

\begin{center}
\begin{tikzpicture}
%\draw[fill=gray!23,gray!23](0,0) rectangle (13,4);
%\draw[step=0.5cm,gray,very thin] (0,0) grid (13,4); %background grid
\draw[very thick, violet] (1,1)--(3,1)--(3,3)--(1,3) --cycle ; %square
\node[] at (0.9,0.9) {\small $1$};
\node[] at (3.1,0.9) {\small $2$};
\node[] at (3.1,3.1) {\small $3$};
\node[] at (0.9,3.1) {\small $4$};
\draw[very thick, violet] (4,1)--(7,1)--(7,3)--(4,3) --cycle ; %rectangle
\node[] at (3.9,0.9) {\small $1$};
\node[] at (7.1,0.9) {\small $2$};
\node[] at (7.1,3.1) {\small $3$};
\node[] at (3.9,3.1) {\small $4$};
\draw[very thick, violet] (8,1)--(11,1)--(12,3)--(9,3) --cycle ; %parallelogram
\node[] at (7.9,0.9) {\small $1$};
\node[] at (11.1,0.9) {\small $2$};
\node[] at (12.1,3.1) {\small $3$};
\node[] at (8.9,3.1) {\small $4$};
\end{tikzpicture}
\end{center}

For the square of size $h$ we have 
\begin{eqnarray}
4A_2 &=& x_1 -x_2 +x_3 -x_4 = x_1 -(x_1+h) +(x_4+h) -x_4) =0 \nonumber\\
4A_4 &=& x_1 -x_2 +x_3 -x_4 = x_1 -(x_1+h) +(x_4+h) -x_4  =0 \nonumber\\
4B_2 &=& y_1 -y_2 +y_3 -y_4 = y_1 -y_2 + (y_2+h_y) -(y_1+h_y) = 0 \nonumber\\
4B_4 &=& y_1 -y_2 +y_3 -y_4 = y_1 -y_2 + (y_2+h_y) -(y_1+h_y) = 0 \nonumber
\end{eqnarray}
For the rectangle of size $h_x,h_y$ we have 
\begin{eqnarray}
4A_2 &=& x_1 -x_2 +x_3 -x_4 = x_1 -(x_1+h_x) +(x_4+h_x) -x_4) =0 \nonumber\\
4A_4 &=& x_1 -x_2 +x_3 -x_4 = x_1 -(x_1+h_x) +(x_4+h_x) -x_4  =0 \nonumber\\
4B_2 &=& y_1 -y_2 +y_3 -y_4 = y_1 -y_2 + (y_2+h_y) -(y_1+h_y) = 0 \nonumber\\
4B_4 &=& y_1 -y_2 +y_3 -y_4 = y_1 -y_2 + (y_2+h_y) -(y_1+h_y) = 0 \nonumber
\end{eqnarray}
and the same for the parallelogram.





In the case of a rectangle we also have
\begin{eqnarray}
A_1&=&\frac14(-x_1 +x_2 +x_3 -x_4)=\frac14(-x_1 +(x_1+h_x) +(x_4+h_x) -x_4) = \frac{h_x}{2} \nn\\
A_3&=&\frac14(-x_1 -x_2 +x_3 +x_4)=\frac14( -x_1 -(x_1+h_x) +(x_4+h_x) +x_4)  = 0 \nn\\
B_1 &=& \frac14 (-y_1 +y_2 +y_3 -y_4) = \frac14(-y_1 + y_2 + (y_2 +h_y) - (y_1+h_y)) = 0 \nn\\
B_3&=& \frac14(-y_1 -y_2 +y_3 +y_4) = \frac14 (-y_1 -y_2 + (y_2+h_y)+ (y_1+h_y)) = \frac{h_y}{2} \nn
\end{eqnarray}
and something very similar for the square with $h=h_x=h_y$.

For these quadrilaterals we then have
\[
{\bm J}^{-1} = \frac{1}{C}
\left(
\begin{array}{cc}
B_3  & -B_1  \\
-A_3  & A_1 
\end{array}
\right)
\qquad 
{\rm with }
\qquad
C= A_1B_3-A_3  B_1 
\]
and in the case of the rectangle:
\[
{\bm J} 
= \left(
\begin{array}{cc}
A_1  & B_1  \\
A_3  & B_3 
\end{array}
\right)
= \left(
\begin{array}{cc}
\frac{h_x}{2}  & 0  \\
0  & \frac{h_y}{2}
\end{array}
\right)
\]
The determinant is then $C=\frac{h_xh_y}{4}$ and the inverse:
\[
{\bm J}^{-1}
= 
\frac{1}{C}
\left(
\begin{array}{cc}
B_3  & -B_1  \\
-A_3  & A_1
\end{array}
\right)
= 
\frac{4}{h_xh_y}
\left(
\begin{array}{cc}
\frac{h_y}{2}  & 0  \\
0  & \frac{h_x}{2}
\end{array}
\right)
=
\left(
\begin{array}{cc}
\frac{2}{h_x}  & 0  \\
0  & \frac{2}{h_y}
\end{array}
\right)
\]


\begin{remark}
\textcite{hua90} (1990) has published analytical inverse transformation 
for quadrilateral isoparametric elements, i.e. how to compute ${\bm J}^{-1}$ 
as a function of space coordinates and not just at the quadrature points. 
\end{remark}


%==============================================================================
\section{Biquadratic mapping of a straight-edge face $Q_2$ element }

\begin{center}
\includegraphics[width=8cm]{images/mappings/biquadratic/mapping1}
\end{center}

The reference element now contains 9 nodes: 1,3,7,9 are the corners, nodes
2,4,6,8 are the mid-face points and node 5 is in the middle\footnote{Note that 
this numbering is quite arbitrary}.
The mapping from the $(r,s)$ space to the $(x,y)$ space is then as follows:

\begin{eqnarray}
\left(\begin{array}{c}
x(r,s) \\ y(r,s)
\end{array}\right)
=\sum_{i=1}^9 
\bN_i(r,s)\left(\begin{array}{c} x_i \\ y_i \end{array}\right)
&=&
\bN_1(r,s)\left(\begin{array}{c} x_1 \\ y_1 \end{array}\right)
+
\bN_2(r,s)\left(\begin{array}{c} x_2 \\ y_2 \end{array}\right)
+
\bN_3(r,s)\left(\begin{array}{c} x_3 \\ y_3 \end{array}\right)\nonumber\\
&+&
\bN_4(r,s)\left(\begin{array}{c} x_4 \\ y_4 \end{array}\right)
+
\bN_5(r,s)\left(\begin{array}{c} x_5 \\ y_5 \end{array}\right)
+
\bN_6(r,s)\left(\begin{array}{c} x_6 \\ y_6 \end{array}\right)\nonumber\\
&+&
\bN_7(r,s)\left(\begin{array}{c} x_7 \\ y_7 \end{array}\right)
+
\bN_8(r,s)\left(\begin{array}{c} x_8 \\ y_8 \end{array}\right) 
+
\bN_9(r,s)\left(\begin{array}{c} x_9 \\ y_9 \end{array}\right) \nonumber
\end{eqnarray}
where the $Q_2$ basis functions have been obtained in Section~\ref{ss:q22d}:
\begin{eqnarray}
\bN_1(r,t)&=& 0.5r(r-1)  0.5t(t-1) \nonumber\\
\bN_2(r,t)&=&      (1-r^2)  0.5t(t-1) \nonumber\\
\bN_3(r,t)&=& 0.5r(r+1)  0.5t(t-1) \nonumber\\
\bN_4(r,t)&=& 0.5r(r-1)       (1-t^2) \nonumber\\
\bN_5(r,t)&=&      (1-r^2)       (1-t^2) \nonumber\\
\bN_6(r,t)&=& 0.5r(r+1)       (1-t^2) \nonumber\\
\bN_7(r,t)&=& 0.5r(r-1)  0.5t(t+1) \nonumber\\
\bN_8(r,t)&=&      (1-r^2)  0.5t(t+1) \nonumber\\
\bN_9(r,t)&=& 0.5r(r+1)  0.5t(t+1) \nonumber
\end{eqnarray}

As in the previous section I have written a simple Python script that 
computes the image of 10,000 points generated in the reference element
using the forward mapping based on the $Q_2$ basis functions:
\begin{lstlisting}
x1=-1                 ; y1=-2
x3=3                  ; y3=-1
x9=2                  ; y9=2
x7=-3                 ; y7=1
x2=0.5*(x1+x3)        ; y2=0.5*(y1+y3)
x4=0.5*(x1+x7)        ; y4=0.5*(y1+y7)
x6=0.5*(x3+x9)        ; y6=0.5*(y3+y9)
x8=0.5*(x7+x9)        ; y8=0.5*(y7+y9)
x5=0.25*(x1+x3+x7+x9) ; y5=0.25*(y1+y3+y7+y9)

npts=10000
r=np.zeros(npts,dtype=np.float64)   
s=np.zeros(npts,dtype=np.float64)   
xQ1=np.zeros(npts,dtype=np.float64)   
yQ1=np.zeros(npts,dtype=np.float64)   
xQ2=np.zeros(npts,dtype=np.float64)   
yQ2=np.zeros(npts,dtype=np.float64)   

for i in range(0,npts):
    # compute random r,s coordinates
    r[i]=random.uniform(-1.,+1)
    s[i]=random.uniform(-1.,+1)
    # compute Q2 basis function values at r,s
    N1= 0.5*r[i]*(r[i]-1.) * 0.5*s[i]*(s[i]-1.)
    N2=       (1.-r[i]**2) * 0.5*s[i]*(s[i]-1.)
    N3= 0.5*r[i]*(r[i]+1.) * 0.5*s[i]*(s[i]-1.)
    N4= 0.5*r[i]*(r[i]-1.) *       (1.-s[i]**2)
    N5=       (1.-r[i]**2) *       (1.-s[i]**2)
    N6= 0.5*r[i]*(r[i]+1.) *       (1.-s[i]**2)
    N7= 0.5*r[i]*(r[i]-1.) * 0.5*s[i]*(s[i]+1.)
    N8=       (1.-r[i]**2) * 0.5*s[i]*(s[i]+1.)
    N9= 0.5*r[i]*(r[i]+1.) * 0.5*s[i]*(s[i]+1.)
    # compute x,y coordinates
    xQ2[i]=N1*x1+N2*x2+N3*x3+N4*x4+N5*x5+N6*x6+N7*x7+N8*x8+N9*x9
    yQ2[i]=N1*y1+N2*y2+N3*y3+N4*y4+N5*y5+N6*y6+N7*y7+N8*y8+N9*y9
    # compute Q1 basis function values at r,s
    N1=0.25*(1-r[i])*(1-s[i])
    N2=0.25*(1+r[i])*(1-s[i])
    N3=0.25*(1+r[i])*(1+s[i])
    N4=0.25*(1-r[i])*(1+s[i])
    # compute x,y coordinates
    xQ1[i]=N1*x1+N2*x3+N3*x9+N4*x7
    yQ1[i]=N1*y1+N2*y3+N3*y9+N4*y7

np.savetxt('rs.ascii',np.array([r,s]).T)
np.savetxt('xyQ1.ascii',np.array([xQ1,yQ1]).T)
np.savetxt('xyQ2.ascii',np.array([xQ2,yQ2]).T)
\end{lstlisting}

The code is available in {\tt /images/mappings/biquadratic}
Note that the coordinates of point 5 are defined being those of the 
average of the corner coordinates of the quadrilateral. More on this choice later.

\begin{center}
\includegraphics[width=5.7cm]{images/mappings/biquadratic/rs.pdf}
\includegraphics[width=5.7cm]{images/mappings/biquadratic/xyQ1.pdf}
\includegraphics[width=5.7cm]{images/mappings/biquadratic/xyQ2.pdf}\\
{\captionfont Left: 10,000 random points in the reference element; 
image of these points by means of a bilinear (middle) and biquadratic (right)
mapping respectively.}
\end{center}
When the sides of the element are straight we see that a $Q_1$ mapping is sufficient.

%.................................................................
\section{Biquadratic mapping of a not-so straight-line face $Q_2$ element }

We now carry out the same exercise as before but nodes 2 and 8 are no more 
in the middle of nodes 1-3 and 7-9 respectively.
The code is available in {\tt /images/mappings/biquadratic2}.

\begin{center}
\includegraphics[width=5.7cm]{images/mappings/biquadratic2/rs.pdf}
\includegraphics[width=5.7cm]{images/mappings/biquadratic2/xyQ1.pdf}
\includegraphics[width=5.7cm]{images/mappings/biquadratic2/xyQ2.pdf}\\
{\captionfont Left: 10,000 random points in the reference element; 
image of these points by means of a bilinear (middle) and biquadratic mapping 
respectively (right).} 
\end{center}

In this case we see that 
the $Q_2$ mapping manages to better capture the 'real' shape of the element.
Since nodes 2 and 8 have moved, we could now ask ourselves 
where we should place node 5? In this example we set it as follows
but it is somewhat arbitrary.
\begin{lstlisting}
x5=(x1+x2+x3+x4+x6+x7+x8+x9)/8. 
y5=(y1+y2+y3+y4+y6+y7+y8+y9)/8.
\end{lstlisting}
We will come back to this later.

%.......................................................................
\section{Bilinear, biquadratic and bicubic mapping in an annulus }

In the light of what precedes, we can now ask ourselves how this translates to 
a real geodynamic case. Let us then consider the case of an annular domain, 
a cross section of a hollow sphere. 
When using quadrilateral elements, the mesh will look similar to this:

\begin{center}
\includegraphics[width=6cm]{images/mappings/curved/annulus_mesh}
\end{center}

We here focus on $Q_1$, $Q_2$ and $Q_3$ mappings. We single out an element, 
and arbitrarily define it as follows in polar coordinates:
\begin{lstlisting}
theta1=23./180.*np.pi
theta2=52./180.*np.pi
R1=1.
R2=1.5
\end{lstlisting}
The $Q_1$ mapping requires four points, the $Q_2$ nine points and the $Q_3$
sixteen points. 
The code used in the following is available at {\tt ./images/mappings/curved/}.
These are placed equidistantly in the $r,\theta$ coordinate
system, as shown hereunder:

\begin{center}
\includegraphics[width=7cm]{images/mappings/curved/nodesQ1.pdf}
\includegraphics[width=7cm]{images/mappings/curved/nodesQ2.pdf}\\
\includegraphics[width=7cm]{images/mappings/curved/nodesQ3.pdf}
\includegraphics[width=7cm]{images/mappings/curved/nodesQ4.pdf}\\
{\captionfont Position of the nodes for the $Q_1$, $Q_2$, $Q_2$ and $Q_4$ mappings.}
\end{center}

As before, we randomly shoot 10,000 points inside the reference element 
and map these out in the $x,y$ space. Resulting swarms of points are shown 
in the following figures:

\begin{center}
\includegraphics[width=7cm]{images/mappings/curved/xy1_volume.pdf}
\includegraphics[width=7cm]{images/mappings/curved/xy2_volume.pdf}\\
\includegraphics[width=7cm]{images/mappings/curved/xy3_volume.pdf}
\includegraphics[width=7cm]{images/mappings/curved/xy3_volume.pdf}\\
{\captionfont Left to right: position of the mapped points for the $Q_1$, $Q_2$, $Q_3$ 
and $Q_4$ mappings.}
\end{center}

The image of a square with a $Q_1$ mapping is obviously a quadrilateral
so that it looks like quite a few points land outside of the domain $R_1\leq r\leq R_2$.
Note that points are well within $23\degree \leq \theta \leq 52\degree$, which can 
simply be explained by the fact that the faces of the element joining $R_1$
to $R_2$ are straight lines.

However, it looks like the biquadratic and bicubic mappings are doing a much better 
job at mapping the region of space $R_1\leq r\leq R_2$. In order to characterise 
this better, we now place 10,000 points on the bottom face of 
the reference element (i.e. $s=-1$)
and once again compute their coordinates in the the $x,y$ space:

\begin{center}
\includegraphics[width=8cm]{images/mappings/curved/xy1_line.pdf}
\includegraphics[width=8cm]{images/mappings/curved/xy2_line.pdf}\\
\includegraphics[width=8cm]{images/mappings/curved/xy3_line.pdf}
\includegraphics[width=8cm]{images/mappings/curved/xy4_line.pdf}\\
{\captionfont Position of the mapped points for the $Q_1$, $Q_2$, $Q_3$ and $Q_4$ mappings.}
\end{center}

For each point $i$ we now compute the distance $r_i$ 
to the origin, which, if the 
mapping was perfect, would be exactly equal to $R_1=1$. 
On the following plots are shown the error $r_i-1$ for all 
points, from $r=-1$ to $r=+1$.

\begin{center}
\includegraphics[width=8cm]{images/mappings/curved/innerline_error_Q1mapping.pdf}
\includegraphics[width=8cm]{images/mappings/curved/innerline_error_Q2mapping.pdf}\\
\includegraphics[width=8cm]{images/mappings/curved/innerline_error_Q3mapping.pdf}
\includegraphics[width=8cm]{images/mappings/curved/innerline_error_Q4mapping.pdf}\\
{\captionfont Radius error of the mapped points for the $Q_1$, $Q_2$, $Q_3$ and $Q_4$ mappings.}
\end{center}

We see that the amplitude of the error decreases with the order of the mapping used, 
which is why for instance \aspect uses a $Q_4$ mapping by default\footnote{I find it also quite striking 
that the $Q_4$ mapping outperforms the $Q_3$ one by two orders of magnitude...}.
Actually, in this particular case, the equation which describes the circle is not a 
polynomial so that no high-order mapping will ever be able to {\it exactly} 
represent the curved boundary of the element!

Another interesting point to keep in mind is that the location of the quadrature points
in the $x,y$ space is also determined by the mapping used, which can have consequences
on the accuracy of the integration and it will be reflected (for instance) on the 
error convergence rate.

As already mentioned previously, 
the coordinates of the nodes of the element in the $x,y$ are 
uniquely determined when they are on the convex hull of the element (
for instance nodes 0-7 for $Q_2$) but we need to choose the position 
of the last nodes which are inside the element. Unfortunately, this choice is 
not neutral. 

Finally, we can explore the importance of the mapping in combination with 
numerical quadrature. For each mapping we compute the area of the element
by means of a 3x3, 4x4 or 5x5 quadrature.

\begin{verbatim}
**********Q1*********
nqperdim= 3 0.3030060126539606 rel. error -0.04215361698430029
nqperdim= 4 0.3030060126539606 rel. error -0.04215361698430012 ~ 4%
nqperdim= 5 0.3030060126539606 rel. error -0.04215361698430012
**********Q2*********
nqperdim= 3 0.3162980025394154 rel. error -0.00013569026611326453
nqperdim= 4 0.3162980025394155 rel. error -0.00013569026611308905 ~ 0.01%
nqperdim= 5 0.3162980025394154 rel. error -0.00013569026611326453
**********Q3*********
nqperdim= 3 0.3163472223929359 rel. error 1.9900899402587318e-05
nqperdim= 4 0.316347222392936  rel. error 1.9900899402938278e-05 ~ 0.002%
nqperdim= 5 0.316347222392936  rel. error 1.9900899402938278e-05
**********Q4*********
nqperdim= 3 0.3163409410866220 rel. error 4.477021014282521e-08
nqperdim= 4 0.3163409541901677 rel. error 8.619243716974044e-08 ~ 0.000008%
nqperdim= 5 0.316340954190168  rel. error 8.619243804713484e-08
\end{verbatim}

Here again the $Q_4$ mapping makes quite the difference. 

\newpage

%..................................................................
\section{Biquadratic mapping - the middle node conundrum}

Python code at {\tt images/mappings/biquadratic3}.

As mentioned before, unless the element is a straight-edge quadrilateral, 
determining the (best) position of the middle node is not trivial. Or is it?

Let us recall the internal numbering of nodes:
\begin{verbatim}
4--7--3
|     |
8  9  6   (reference element)
|     |
1--5--2
\end{verbatim}


We can think of multiple ways to come up with the `center' of the element, 
i.e. the location of node \#9. %this point that we denote by $I$.
In the code these different approaches are parameterized by means of the
\lstinline{center} variable:

\begin{itemize}
\item \lstinline{center=0}: The middle node coordinates are simply the 
average of the corner coordinates 
\begin{align}
x_9&=(x_1+x_2+x_3+x_4)/4 \nn\\
y_9&=(y_1+y_2+y_3+y_4)/4 \nn
\end{align}

\item \lstinline{center=1}: The middle coordinates are the average all the 
4 corners and 4 mid-edge nodes coordinates:

\begin{align}
x_9&=(x_1+x_2+x_3+x_4+x_5+x_6+x_7+x_8)/8 \nn\\
y_9&=(y_1+y_2+y_3+y_4+y_5+y_6+y_7+y_8)/8 \nn
\end{align}

\item \lstinline{center=2}: The middle coordinates are obtained via a 
weighed sum of the corner coordinates and the mid-edge nodes 
coordinates\footnote{I have no idea where this comes from.}: 

\begin{align}
x_9&=(x_1+x_2+x_3+x_4+3x_5+3x_6+3x_7+3x_8)/16. \nn\\
y_9&=(y_1+y_2+y_3+y_4+3y_5+3y_6+3y_7+3y_8)/16. \nn
\end{align}

\item \lstinline{center=3}: This only applies to element \#4 that is defined on an annulus:

\begin{align}
x_9&=\frac12(R_1+R_2)\cos(3\pi/8) \nn\\
y_9&=\frac12(R_1+R_2)\sin(3\pi/8) \nn
\end{align}


\item \lstinline{center=4}: This only applies to element \#4 that is 
defined by $R_1<r<R_2$ and $\theta_1<\theta<\theta_2$. Node \#9 is the center of mass. 

\todo[inline]{other elements}

We need to compute\footnote{\url{https://en.wikipedia.org/wiki/Center_of_mass}}
\begin{eqnarray}
\vec{R} 
&=&\frac{1}{M} \int \vec{r} \rho(\vec r) dV \nn\\
&=&\frac{1}{M} \rho_0 \int \vec{r} dV\nn\\
&=&\frac{1}{M} \frac{M}{V} \int \vec{r} dV\nn\\
&=&\frac{1}{V} \int \vec{r} dV\nn\\
&=&\frac{1}{V} \int \left(\begin{array}{c} x \\ y \end{array}\right)  dV\nn\\
&=&\frac{1}{V} \int \left(\begin{array}{c} r \cos \theta \\ r \sin\theta \end{array}\right)dV\nn\\
&=&\frac{1}{V} \int_{R_1}^{R_2} \int_{\theta_1}^{\theta_2} \left(\begin{array}{c} r \cos \theta 
\\ r \sin\theta \end{array}\right)  r dr d\theta\nn\\
&=&\frac{1}{\frac12 (R_2^2-R_1^2) (\theta_2-\theta_1)} \frac13(R_2^3-R_1^3) 
\left(
\begin{array}{c}
\sin\theta_2-\sin\theta_1 \\
-\cos\theta_2+\cos\theta_1 
\end{array}
\right) \nn\\
&\simeq& 
\left(
\begin{array}{c}
0.5801028000103104\\
1.4004920473554983
\end{array}
\right) 
\end{eqnarray}
which corresponds to $r=1.5158816686291174$ and $\theta=67.5^o=3\pi/8$.

\item \lstinline{center=5}: variable position

\item \lstinline{center=6}: This approach is a bit more complex than the previous ones.
We start by acknowledging that we know the coordinates of nodes 1-8 in the reference space $(r,s)$ 
and in the real space $(x,y)$ so one could then use a $Q_2^{(8)}$ mapping (i.e. 'serendipity' $Q_2$)
to place node \#9.

In this case the basis functions for this mapping are defined in Section~\ref{sec:serendipity2D}:
\begin{eqnarray}
\bN_0(r,s)&=& \frac{1}{4}(1-r)(1-s)(-r-s-1) \nn\\
\bN_1(r,s)&=& \frac{1}{4}(1+r)(1-s)(r-s-1) \nn\\
\bN_2(r,s)&=& \frac{1}{4}(1+r)(1+s)(r+s-1) \nn\\
\bN_3(r,s)&=& \frac{1}{4}(1-r)(1+s)(-r+s-1) \nn\\
\bN_4(r,s)&=& \frac{1}{2}(1-r^2)(1-s)  \nn\\
\bN_5(r,s)&=& \frac{1}{2}(1+r)  (1-s^2)\nn\\
\bN_6(r,s)&=& \frac{1}{2}(1-r^2)(1+s)  \nn\\
\bN_7(r,s)&=& \frac{1}{2}(1-r)  (1-s^2) \nn
\end{eqnarray}

We would then compute the location of node 9 as follows (its $r,s$ coordinates are $0,0$): 
\begin{eqnarray}
x_9 
&=& \sum_{i=1}^8 \bN_i (r_9,s_9) x_i \nn\\
&=& \sum_{i=1}^8 \bN_i (0,0) x_i \nn\\
&=& -\frac14 (x_1+x_2+x_3+x_4) + \frac12 (x_5+x_6+x_7+x_8) \nn\\
y_9 
&=& \sum_{i=1}^8 \bN_i (r_9,s_9) y_i \nn\\
&=& \sum_{i=1}^8 \bN_i (0,0) y_i \nn\\
&=& -\frac14 (y_1+y_2+y_3+y_4) + \frac12 (y_5+y_6+y_7+y_8) \nn
\end{eqnarray}


\end{itemize}

%...............................
\subsection*{About the code}

In all what follows we use a $Q_2$ isoparametric mapping.

For simplicity I use in what follows the function $f(x,y)=x^3+y^3$.
At each point $(r,s)\in [-1,1]^2$ with real coordinates ($x(r,s),y(r,s)$) 
we compute the error $e_f=\sum_i \bN_i(r,s) f_i  - f(xi(r,s),y(r,s))$ 
where $f_i$ are the values of the function evaluated at the 9 nodes.
We also compute the error on the first order derivatives, i.e.
$e_{df/dx}=\sum_i \bN_i(r,s) (df/dx)_i  - df/dx(x(r,s),y(r,s))$ 
and $e_{df/dy}=\sum_i \bN_i(r,s) (df/dy)_i  - df/dy(x(r,s),y(r,s))$.

Unless indicated otherwise $3 \times 3$ quadrature is used to a) compute
the area of the element; b) compute the errors above in the $L_2$ norm,
e.g. $E_f=\left(\int_\Omega (e_f)^2 dV \right)^{1/2}$ (I purposefully do not 
divide by the area) and $E_{\nabla f}=\left(\int_\Omega (e_{df/dx}^2+e_{df/dy}^2) dV \right)^{1/2}$.

We find that for all element shapes the measured area seems to be independent 
of the position of middle node. Why?

We note that the position of edges obtained from the 
forward mapping by setting $r=\pm 1$ and/or $s=\pm 1$ are in fact
independent of the position of the middle node since shape functions are zero there.
For example, setting $s=-1$ means that for terms containing 
this summation $\sum_i \bN_i(r,s) ...$  only contributions by nodes
1,5,2 count (basis functions $\bN_{3,4,6,7,8,9}$ are zero for $s=-1$).
When computing $y=\sum_i \bN_i(r,s=-1) y_i$ then the result is 
independent of $y_9$. Same for all sides.
 
\vspace{.5cm}

The Python code is built as follows:
\begin{verbatim}
for center in centers:
    assign middle point coordinates
    generate npts points at random in reference cell
    compute error on f,df/dx,df/dy and jacobian at each point
    export points and their fields to vtu
    compute area and integral of errors over element
\end{verbatim}

Warning: Note that all the conclusions drawn hereafter are provisory:
only *one* function was used which is arbitrarily chosen to be a 3rd order polynomial,
and the coordinates/shapes of the elements 1,2,3 are also arbitrary and results
may differ with different configurations!



\newpage
%------------------------------------------------------------------------------
\subsection*{Element 0}
\begin{center}
\includegraphics[width=3.5cm]{images/mappings/biquadratic3/elt0/element0}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt0/nodes}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt0/nodes_zoom}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt0/quad_points}\\
{\captionfont From left to right: element and its 8 boundary nodes.
Location of the 9 nodes for different values of the center parameter.
Zoom on the middle node. 
Position of the quadrature points for different values of the center parameter.}
\end{center}
\begin{lstlisting}
   x1=-1              ; y1=-1
   x2=1               ; y2=-1
   x3=1               ; y3=1
   x4=-1              ; y4=1
   x5=0.5*(x1+x2)     ; y5=0.5*(y1+y2)
   x6=0.5*(x2+x3)     ; y6=0.5*(y2+y3)
   x7=0.5*(x3+x4)     ; y7=0.5*(y3+y4)
   x8=0.5*(x1+x4)     ; y8=0.5*(y1+y4)
\end{lstlisting}

In this case all only {\python center=0,1,2,4,6} are applicable but they all 
lead to the same middle point with $x_9=0,y_9=0$. This means that the position of 
quadrature points is also independent of the {\python center} parameter.

\begin{tiny}
\begin{verbatim}
element= 0, npts= 1000000, nqperdim= 3
============================================================
center= 0 x9,y9= 0.000000e+00 0.000000e+00 
center= 0 min/max/avrg jcob on pts   = 1.000000e+00 1.000000e+00 1.000000e+00
center= 0 min/max/avrg err_f on pts   = -7.697997e-01 7.697981e-01 1.032961e-04
center= 0 min/max/avrg err_dfdx on pts= -1.999994e+00 1.000000e+00 9.897925e-04
center= 0 min/max/avrg err_dfdy on pts= -1.999998e+00 1.000000e+00 -4.337008e-04
center= 0 int err_f= 6.531973e-01
center= 0 int err_gradf= 2.529822e+00
center= 0 area= 4.000000e+00
============================================================
center= 1 x9,y9= 0.000000e+00 0.000000e+00 
center= 1 min/max/avrg jcob on pts   = 1.000000e+00 1.000000e+00 1.000000e+00
center= 1 min/max/avrg err_f on pts   = -7.697981e-01 7.697978e-01 -1.037079e-04
center= 1 min/max/avrg err_dfdx on pts= -1.999994e+00 1.000000e+00 5.562081e-04
center= 1 min/max/avrg err_dfdy on pts= -1.999992e+00 1.000000e+00 -6.057413e-04
center= 1 int err_f= 6.531973e-01
center= 1 int err_gradf= 2.529822e+00
center= 1 area= 4.000000e+00
============================================================
center= 2 x9,y9= 0.000000e+00 0.000000e+00 
center= 2 min/max/avrg jcob on pts   = 1.000000e+00 1.000000e+00 1.000000e+00
center= 2 min/max/avrg err_f on pts   = -7.698001e-01 7.697999e-01 -4.504134e-04
center= 2 min/max/avrg err_dfdx on pts= -1.999985e+00 1.000000e+00 4.678516e-04
center= 2 min/max/avrg err_dfdy on pts= -1.999987e+00 1.000000e+00 1.466204e-03
center= 2 int err_f= 6.531973e-01
center= 2 int err_gradf= 2.529822e+00
center= 2 area= 4.000000e+00
============================================================
center= 6 x9,y9= 0.000000e+00 0.000000e+00 
center= 6 min/max/avrg jcob on pts   = 1.000000e+00 1.000000e+00 1.000000e+00
center= 6 min/max/avrg err_f on pts   = -7.697964e-01 7.698001e-01 -3.862548e-04
center= 6 min/max/avrg err_dfdx on pts= -1.999996e+00 1.000000e+00 -3.443542e-04
center= 6 min/max/avrg err_dfdy on pts= -1.999992e+00 1.000000e+00 -9.219252e-04
center= 6 int err_f= 6.531973e-01
center= 6 int err_gradf= 2.529822e+00
center= 6 area= 4.000000e+00
============================================================
\end{verbatim}
\end{tiny}

We find that the jacobian is exactly 1 everywhere in the element which 
is what we expected since $|J|=4/h_xh_y=4/2\cdot 2=1$.
Likewise area measurements are all identical and equal to $h_xh_y$.

Conclusions:
\begin{itemize}
\item In the case of square/rectangular elements the middle node
location is indeed 'in the middle'.
\item we obviously recover the same values for $e_f$ and $E_{\nabla f}$
\item Even using 1,000,000 points we find that the min/max/avrg values
of pointwise errors show significant differences (esp. the average). 
In the future we'll then only consider $E$ errors. 
\end{itemize}


%\begin{center}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt0/jcob}
%{\captionfont 10,000 points at random.} 
%\end{center}


\newpage
%------------------------------------------------------------------------------
\subsection*{Element 1}
\begin{center}
\includegraphics[width=3.5cm]{images/mappings/biquadratic3/elt1/element1}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt1/nodes}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt1/nodes_zoom}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt1/quad_points}
\end{center}
\begin{lstlisting}
   x1=-1              ; y1=-2
   x2=3               ; y2=-1
   x3=2               ; y3=2
   x4=-3              ; y4=1
   x5=0.5*(x1+x2)     ; y5=0.5*(y1+y2)
   x6=0.5*(x2+x3)     ; y6=0.5*(y2+y3)
   x7=0.5*(x3+x4)     ; y7=0.5*(y3+y4)
   x8=0.5*(x1+x4)     ; y8=0.5*(y1+y4)
\end{lstlisting}

In this case only {\python center=0,1,2,4,6} are applicable but they all 
lead to the same middle point with $x_9=0,y_9=0$. This means that the position of 
quadrature points is also independent of the {\python center} parameter.

\begin{tiny}
\begin{verbatim}
element= 1, npts= 1000000, nqperdim= 3
============================================================
center= 0 x9,y9= 2.500000e-01 0.000000e+00 
center= 0 min/max/avrg jcob on pts   = 3.250362e+00 4.249199e+00 3.750057e+00
center= 0 min/max/avrg err_f on pts   = -6.060741e+00 6.666524e+00 1.688878e-03
center= 0 min/max/avrg err_dfdx on pts= -1.099651e+01 6.443612e+00 -5.010148e-03
center= 0 min/max/avrg err_dfdy on pts= -1.015984e+01 4.225070e+00 1.686068e-02
center= 0 int err_f= 1.107770e+01
center= 0 int err_gradf= 1.954635e+01
center= 0 area= 1.500000e+01
============================================================
center= 1 x9,y9= 2.500000e-01 0.000000e+00 
center= 1 min/max/avrg jcob on pts   = 3.250930e+00 4.249578e+00 3.749771e+00
center= 1 min/max/avrg err_f on pts   = -6.060172e+00 6.666509e+00 -4.038311e-03
center= 1 min/max/avrg err_dfdx on pts= -1.099842e+01 6.444102e+00 -1.172403e-04
center= 1 min/max/avrg err_dfdy on pts= -1.018956e+01 4.225064e+00 1.654201e-02
center= 1 int err_f= 1.107770e+01
center= 1 int err_gradf= 1.954635e+01
center= 1 area= 1.500000e+01
============================================================
center= 2 x9,y9= 2.500000e-01 0.000000e+00 
center= 2 min/max/avrg jcob on pts   = 3.251054e+00 4.249622e+00 3.750130e+00
center= 2 min/max/avrg err_f on pts   = -6.060921e+00 6.666524e+00 -6.843429e-03
center= 2 min/max/avrg err_dfdx on pts= -1.099522e+01 6.441666e+00 -3.864851e-03
center= 2 min/max/avrg err_dfdy on pts= -1.018380e+01 4.225069e+00 1.319091e-02
center= 2 int err_f= 1.107770e+01
center= 2 int err_gradf= 1.954635e+01
center= 2 area= 1.500000e+01
============================================================
center= 6 x9,y9= 2.500000e-01 0.000000e+00 
center= 6 min/max/avrg jcob on pts   = 3.250841e+00 4.249203e+00 3.749670e+00
center= 6 min/max/avrg err_f on pts   = -6.060064e+00 6.666475e+00 -9.101238e-04
center= 6 min/max/avrg err_dfdx on pts= -1.099351e+01 6.443416e+00 -7.271667e-03
center= 6 min/max/avrg err_dfdy on pts= -1.016288e+01 4.225062e+00 1.436911e-02
center= 6 int err_f= 1.107770e+01
center= 6 int err_gradf= 1.954635e+01
center= 6 area= 1.500000e+01
============================================================
\end{verbatim}
\end{tiny}
 
%\begin{center}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt1/jcob}
%{\captionfont 10,000 points at random.} 
%\end{center}


Conclusions:
\begin{itemize}
\item Exactly the same conclusions as for element 0 can be drawn.
\end{itemize} 




\newpage
%------------------------------------------------------------------------------
\subsection*{Element 2}
\begin{center}
\includegraphics[width=3.5cm]{images/mappings/biquadratic3/elt2/element2}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt2/nodes}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt2/nodes_zoom}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt2/quad_points}
\end{center}
\begin{lstlisting}
   x1=-1 ; y1=-2
   x2=3  ; y2=-1
   x3=2  ; y3=2
   x4=-3 ; y4=1
   x5=0.5*(x1+x2) ; y5=0.5*(y1+y2) -0.25
   x6=0.5*(x2+x3) ; y6=0.5*(y2+y3)
   x7=0.5*(x3+x4) ; y7=0.5*(y3+y4) +0.5
   x8=0.5*(x1+x4) ; y8=0.5*(y1+y4)
\end{lstlisting}

\begin{tiny}
\begin{verbatim}
element= 2, npts= 1000000, nqperdim= 3
============================================================
center= 0 x9,y9= 2.500000e-01 0.000000e+00 
center= 0 min/max/avrg jcob on pts   = 3.003425e+00 5.833227e+00 4.332919e+00
center= 0 min/max/avrg err_f on pts   = -5.308564e+00 7.373735e+00 1.289018e-01
center= 0 min/max/avrg err_dfdx on pts= -1.323435e+01 6.260039e+00 -3.403394e-02
center= 0 min/max/avrg err_dfdy on pts= -8.721839e+00 5.063460e+00 -6.697600e-02
center= 0 int err_f= 1.183453e+01
center= 0 int err_gradf= 2.148351e+01
center= 0 area= 1.733333e+01
============================================================
center= 1 x9,y9= 2.500000e-01 3.125000e-02 
center= 1 min/max/avrg jcob on pts   = 3.002755e+00 5.696725e+00 4.333505e+00
center= 1 min/max/avrg err_f on pts   = -5.363672e+00 7.293081e+00 9.018116e-02
center= 1 min/max/avrg err_dfdx on pts= -1.323652e+01 6.221262e+00 -2.293697e-02
center= 1 min/max/avrg err_dfdy on pts= -8.682711e+00 5.047551e+00 -6.391543e-02
center= 1 int err_f= 1.178018e+01
center= 1 int err_gradf= 2.141089e+01
center= 1 area= 1.733333e+01
============================================================
center= 2 x9,y9= 2.500000e-01 4.687500e-02 
center= 2 min/max/avrg jcob on pts   = 3.002800e+00 5.630556e+00 4.332764e+00
center= 2 min/max/avrg err_f on pts   = -5.390923e+00 7.252336e+00 7.759085e-02
center= 2 min/max/avrg err_dfdx on pts= -1.321750e+01 6.199422e+00 -2.474020e-02
center= 2 min/max/avrg err_dfdy on pts= -8.715040e+00 5.038157e+00 -6.434275e-02
center= 2 int err_f= 1.175495e+01
center= 2 int err_gradf= 2.137246e+01
center= 2 area= 1.733333e+01
============================================================
center= 6 x9,y9= 2.500000e-01 1.250000e-01 
center= 6 min/max/avrg jcob on pts   = 3.003258e+00 5.340770e+00 4.332317e+00
center= 6 min/max/avrg err_f on pts   = -5.523826e+00 7.044686e+00 1.150397e-02
center= 6 min/max/avrg err_dfdx on pts= -1.321437e+01 6.083445e+00 -9.511932e-03
center= 6 min/max/avrg err_dfdy on pts= -8.679190e+00 4.976683e+00 -5.669887e-02
center= 6 int err_f= 1.164859e+01
center= 6 int err_gradf= 2.115913e+01
center= 6 area= 1.733333e+01
============================================================
\end{verbatim}
\end{tiny}

%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt2/jcob_1}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt2/jcob_2}\\
%{\captionfont 50,000 points at random. From left to right: center=0,1,2.} 
%\end{center}


Conclusions:
\begin{itemize}
\item the four approaches yield 4 different locations for the center.
\item $E_f$ very comparable across all four cases. center=6 seems to be the best
\item Same conclusion $E_{\nabla f}$ 
\end{itemize} 

\newpage
%------------------------------------------------------------------------------
\subsection*{Element 3}
\begin{center}
\includegraphics[width=3.5cm]{images/mappings/biquadratic3/elt3/element3}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/nodes}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/nodes_zoom}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/quad_points}
\end{center}
\begin{lstlisting}
   x1=-1 ; y1=-2
   x2=3  ; y2=-1
   x3=2  ; y3=2
   x4=-3 ; y4=1
   x5=0.5*(x1+x2)     ; y5=0.5*(y1+y2) -0.5
   x6=0.5*(x2+x3)+0.4 ; y6=0.5*(y2+y3) +0.1
   x7=0.5*(x3+x4)     ; y7=0.5*(y3+y4) +0.5
   x8=0.5*(x1+x4)-0.2 ; y8=0.5*(y1+y4) -0.1
\end{lstlisting}

\begin{tiny}
\begin{verbatim}
element= 3, npts= 1000000, nqperdim= 3
============================================================
center= 0 x9,y9= 2.500000e-01 0.000000e+00 
center= 0 min/max/avrg jcob on pts   = 1.907940e+00 5.649991e+00 4.849153e+00
center= 0 min/max/avrg err_f on pts   = -7.275654e+00 9.566299e+00 1.918971e-01
center= 0 min/max/avrg err_dfdx on pts= -1.653858e+01 6.294598e+00 -2.527334e-01
center= 0 min/max/avrg err_dfdy on pts= -2.581218e+01 5.947161e+00 -3.542729e-01
center= 0 int err_f= 1.614533e+01
center= 0 int err_gradf= 2.925334e+01
center= 0 area= 1.940000e+01
============================================================
center= 1 x9,y9= 2.750000e-01 1.387779e-17 
center= 1 min/max/avrg jcob on pts   = 1.903598e+00 5.677286e+00 4.850195e+00
center= 1 min/max/avrg err_f on pts   = -7.297901e+00 9.493156e+00 1.465801e-01
center= 1 min/max/avrg err_dfdx on pts= -1.657761e+01 6.261874e+00 -2.442038e-01
center= 1 min/max/avrg err_dfdy on pts= -2.587333e+01 5.949630e+00 -3.426886e-01
center= 1 int err_f= 1.605547e+01
center= 1 int err_gradf= 2.915732e+01
center= 1 area= 1.940000e+01
============================================================
center= 2 x9,y9= 2.875000e-01 0.000000e+00 
center= 2 min/max/avrg jcob on pts   = 1.904405e+00 5.693478e+00 4.849918e+00
center= 2 min/max/avrg err_f on pts   = -7.308703e+00 9.456916e+00 1.279976e-01
center= 2 min/max/avrg err_dfdx on pts= -1.668960e+01 6.246507e+00 -2.416973e-01
center= 2 min/max/avrg err_dfdy on pts= -2.604266e+01 5.951170e+00 -3.517167e-01
center= 2 int err_f= 1.601397e+01
center= 2 int err_gradf= 2.910870e+01
center= 2 area= 1.940000e+01
============================================================
center= 6 x9,y9= 3.500000e-01 5.551115e-17 
center= 6 min/max/avrg jcob on pts   = 1.913670e+00 5.787307e+00 4.849397e+00
center= 6 min/max/avrg err_f on pts   = -7.359196e+00 9.279116e+00 1.625764e-02
center= 6 min/max/avrg err_dfdx on pts= -1.661175e+01 6.169925e+00 -2.370181e-01
center= 6 min/max/avrg err_dfdy on pts= -2.588039e+01 5.961927e+00 -3.386132e-01
center= 6 int err_f= 1.584097e+01
center= 6 int err_gradf= 2.885993e+01
center= 6 area= 1.940000e+01
============================================================
\end{verbatim}
\end{tiny}

\newpage
\begin{center}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/jcob.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/f.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdx.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdy.0000.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/jcob.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/f.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdx.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdy.0001.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/jcob.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/f.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdx.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdy.0002.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/jcob.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/f.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdx.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt3/dfdy.0003.png}\\
{\captionfont 100,000 points at random. From left to right: jacobian, 
error on $f$, error on $df/dx$ and error on $df/dy$. From top
to bottom: center=0,1,2,6.} 
\end{center}


Conclusions:
\begin{itemize}
\item the four approaches yield 4 different locations for the center.
\item $E_f$ very comparable across all four cases. center=6 seems to be the best
\item Same conclusion $E_{\nabla f}$ 
\end{itemize} 

\begin{center}
\includegraphics[width=7cm]{images/mappings/biquadratic3/elt3/edges}\\
{\captionfont edges obtained by forward $Q_2$ mapping of points $r,s=\pm1$}
\end{center}





\newpage
%------------------------------------------------------------------------------
\subsection*{Element 4}

\begin{center}
\includegraphics[width=3.5cm]{images/mappings/biquadratic3/elt4/element4}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/nodes}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/nodes_zoom}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/quad_points}
\end{center}

\begin{lstlisting}
   R1=1
   R2=2
   dtheta=np.pi/4
   x1=R1*np.cos(np.pi/2-0)               ; y1=R1*np.sin(np.pi/2-0) 
   x5=R1*np.cos(np.pi/2-dtheta/2)        ; y5=R1*np.sin(np.pi/2-dtheta/2) 
   x2=R1*np.cos(np.pi/2-dtheta)          ; y2=R1*np.sin(np.pi/2-dtheta) 
   x8=0.5*(R1+R2)*np.cos(np.pi/2-0)      ; y8=0.5*(R1+R2)*np.sin(np.pi/2-0)  
   x6=0.5*(R1+R2)*np.cos(np.pi/2-dtheta) ; y6=0.5*(R1+R2)*np.sin(np.pi/2-dtheta) 
   x4=R2*np.cos(np.pi/2-0)               ; y4=R2*np.sin(np.pi/2-0)   
   x7=R2*np.cos(np.pi/2-dtheta/2)        ; y7=R2*np.sin(np.pi/2-dtheta/2)   
   x3=R2*np.cos(np.pi/2-dtheta)          ; y3=R2*np.sin(np.pi/2-dtheta)   
\end{lstlisting}



\begin{tiny}
\begin{verbatim}
center of mass coords (x,y): 0.5801028000103104 1.4004920473554983
center of mass coords (r,theta) 1.5158816686291174 67.5
element= 4
npts= 1000000
nqperdim= 3
============================================================
center= 0 x9,y9= 5.303301e-01 1.280330e+00 
center= 0 min/max/avrg jcob on pts   = 1.039732e-01 5.574373e-01 2.943883e-01
center= 0 min/max/avrg err_f on pts   = -2.262961e-01 3.113327e-01 9.571182e-03
center= 0 min/max/avrg err_dfdx on pts= -1.424648e+00 6.317490e-01 7.838307e-03
center= 0 min/max/avrg err_dfdy on pts= -2.934500e+00 1.004204e+00 -2.939049e-02
center= 0 int err_f= 1.333177e-01
center= 0 int err_gradf= 9.290509e-01
center= 0 area= 1.177180e+00
============================================================
center= 1 x9,y9= 5.412539e-01 1.306702e+00 
center= 1 min/max/avrg jcob on pts   = 1.258064e-01 5.136716e-01 2.941058e-01
center= 1 min/max/avrg err_f on pts   = -2.260227e-01 2.814548e-01 5.370194e-03
center= 1 min/max/avrg err_dfdx on pts= -1.425092e+00 6.022714e-01 1.754560e-02
center= 1 min/max/avrg err_dfdy on pts= -2.052857e+00 9.324228e-01 -1.974217e-02
center= 1 int err_f= 1.151357e-01
center= 1 int err_gradf= 8.033761e-01
center= 1 area= 1.177180e+00
============================================================
center= 2 x9,y9= 5.467157e-01 1.319889e+00 
center= 2 min/max/avrg jcob on pts   = 1.367421e-01 4.919188e-01 2.944290e-01
center= 2 min/max/avrg err_f on pts   = -2.261415e-01 2.680915e-01 3.934531e-03
center= 2 min/max/avrg err_dfdx on pts= -1.426224e+00 5.884028e-01 2.200854e-02
center= 2 min/max/avrg err_dfdy on pts= -1.715733e+00 9.007872e-01 -1.831880e-02
center= 2 int err_f= 1.074743e-01
center= 2 int err_gradf= 7.456708e-01
center= 2 area= 1.177180e+00
============================================================
center= 3 x9,y9= 5.740251e-01 1.385819e+00 
center= 3 min/max/avrg jcob on pts   = 1.913594e-01 4.118053e-01 2.942541e-01
center= 3 min/max/avrg err_f on pts   = -2.264001e-01 2.225621e-01 -6.321315e-04
center= 3 min/max/avrg err_dfdx on pts= -1.428531e+00 5.618227e-01 4.015243e-02
center= 3 min/max/avrg err_dfdy on pts= -8.218700e-01 7.798724e-01 -1.818832e-02
center= 3 int err_f= 8.691772e-02
center= 3 int err_gradf= 5.435321e-01
center= 3 area= 1.177180e+00
============================================================
center= 4 x9,y9= 5.801028e-01 1.400492e+00 
center= 4 min/max/avrg jcob on pts   = 2.035020e-01 4.116166e-01 2.943053e-01
center= 4 min/max/avrg err_f on pts   = -2.263658e-01 2.219307e-01 -7.665193e-04
center= 4 min/max/avrg err_dfdx on pts= -1.431221e+00 6.504554e-01 4.500017e-02
center= 4 min/max/avrg err_dfdy on pts= -6.057840e-01 7.625320e-01 -1.938310e-02
center= 4 int err_f= 8.678766e-02
center= 4 int err_gradf= 5.294221e-01
center= 4 area= 1.177180e+00
============================================================
center= 6 x9,y9= 5.740251e-01 1.385819e+00 
center= 6 min/max/avrg jcob on pts   = 1.913468e-01 4.117265e-01 2.942638e-01
center= 6 min/max/avrg err_f on pts   = -2.263541e-01 2.225620e-01 -5.845829e-04
center= 6 min/max/avrg err_dfdx on pts= -1.431369e+00 5.618216e-01 4.034998e-02
center= 6 min/max/avrg err_dfdy on pts= -8.219987e-01 7.798100e-01 -1.843770e-02
center= 6 int err_f= 8.691772e-02
center= 6 int err_gradf= 5.435321e-01
center= 6 area= 1.177180e+00
============================================================
\end{verbatim}
\end{tiny}

\newpage
\begin{center}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0000.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0000.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0001.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0001.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0002.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0002.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0003.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0003.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0004.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0004.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0004.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0004.png}\\
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/jcob.0005.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/f.0005.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdx.0005.png}
\includegraphics[width=4cm]{images/mappings/biquadratic3/elt4/dfdy.0005.png}\\
{\captionfont 1,000,000 points at random. From left to right: jacobian, 
error on $f$, error on $df/dx$ and error on $df/dy$. From top
to bottom: center=0,1,2,3,4,6.} 
\end{center}


Conclusions:
\begin{itemize}
\item approaches 1,2,3 and 3,4,6 yield similar results respectively. 
\item fields also visually look different
\item approaches 3,4,6 yield better results than 1,2,3.
\item area still independent of approach
\end{itemize}




%\begin{center}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt4/jcob_0}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt4/jcob_1}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt4/jcob_2}\\
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt4/jcob_3}
%\includegraphics[width=5.7cm]{images/mappings/biquadratic3/elt4/jcob_4}\\
%{\captionfont 50,000 points at random. From left to right: center=0,1,2,3,4.} 
%\end{center}


%\begin{center}
%\includegraphics[width=8.5cm]{images/mappings/biquadratic3/elt4/nodes}
%\includegraphics[width=8.5cm]{images/mappings/biquadratic3/elt4/quads}\\
%{\captionfont Left: position of the nodes. Right position of quadrature points with 
%nqperdim=3.}
%\end{center}

















\newpage
\vspace{1cm}

\Literature 
\begin{itemize}
\item \fullcite{yuhy94}
\end{itemize}

\newpage
%.............................................................
\section{The Double Jacobian approach \label{ss:doublejac}}

What follows is very much inspired by \textcite{moth20} (2020) with slight changes in the notations.

The basic idea behind this approach is to compute the local to Cartesian mapping 
as a two-stage process, hence the name ``Double Jacobian''. 

\begin{enumerate}
\item 
The first stage maps from local to polar/spherical coordinates and back. This mapping is typically 
to a straight-edged polar or spherical element for which the Jacobian partial derivatives 
are constant within the element. The mapping and its inverse are given by straightforward analytical matrix expressions. 
\item The second stage maps from polar/spherical to Cartesian coordinates (and back) and is also a simple analytical mapping. 
\end{enumerate}
The net Jacobian from local finite element coordinates to a cylindrical or spherical element in Cartesian geometry 
(or any other analytically mapped geometry) is simply the matrix product of two easy-to-compute inverse Jacobian matrices. 
Because the net Jacobian has an analytical form, it can be more rapidly computed than a general 
isoparametric or superparametric finite element mapping.

Remark: in what follows I will denote the polar coordinates by $\uprho,\uptheta$ 
so as to avoid confusion with the reduced/local coordinates $r,s$.

\begin{verbatim}
              J_LC
            --------->          
local (r,s)            Cartesian (x,z)
           <---------          
              J_CL
\end{verbatim}



As we have seen so far the standard approach is as follows:
The relationship between the derivatives of the basis functions with respect to the Cartesian coordinates and the same 
derivatives with respect to the local coordinates is given by:
\[
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial r}{\partial x}  & 
\frac{\partial s}{\partial x}   \\ \\
\frac{\partial r}{\partial z}  & 
\frac{\partial s}{\partial z}  
\end{array}
\right)}_{{\bm J}_{LC}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
\]
where $\bN_i$ are the shape functions, $i$ is the local node numbering of the element, 
$(x,z)$ are the Cartesian coordinates, and $(r,s)$ are the local coordinates within the reference element.
We of course have
\[
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial x}{\partial r}  & 
\frac{\partial z}{\partial r}   \\ \\
\frac{\partial x}{\partial s}  & 
\frac{\partial z}{\partial s}  
\end{array}
\right)}_{{\bm J}_{CL}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
\]
Using an isoparametric mapping:
\[
{\bm J}_{CL}
=
\left(
\begin{array}{cc}
\frac{\partial x}{\partial r}  & 
\frac{\partial z}{\partial r}   \\ \\
\frac{\partial x}{\partial s}  & 
\frac{\partial z}{\partial s}  
\end{array}
\right)
=
\left(
\begin{array}{cc}
\frac{\partial (\sum_i \bN_i x_i)}{\partial r}  & 
\frac{\partial (\sum_i \bN_i z_i)}{\partial r}   \\ \\
\frac{\partial (\sum_i \bN_i x_i)}{\partial s}  & 
\frac{\partial (\sum_i \bN_i z_i)}{\partial s}  
\end{array}
\right)
=
\left(
\begin{array}{cc}
\sum_i\frac{\partial \bN_i}{\partial r}x_i  & 
\sum_i\frac{\partial \bN_i}{\partial r}z_i   \\ \\
\sum_i\frac{\partial \bN_i}{\partial s}x_i  & 
\sum_i\frac{\partial \bN_i}{\partial s}z_i  
\end{array}
\right)
\]

In the end
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
=
{\bm J}_{CL}^{-1} \cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
=
\left(
\begin{array}{cc}
\sum_i\frac{\partial \bN_i}{\partial r}x_i  & 
\sum_i\frac{\partial \bN_i}{\partial r}z_i   \\ \\
\sum_i\frac{\partial \bN_i}{\partial s}x_i  & 
\sum_i\frac{\partial \bN_i}{\partial s}z_i  
\end{array}
\right)^{-1}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
\label{eq:mappDJ1}
\end{equation}

\vspace{.5cm}

In many stones this is coded as follows:
\begin{lstlisting}
jcb=np.zeros((2,2),dtype=np.float64)
for k in range(0,mV):
    jcb[0,0] += dNNNVdr[k]*xV[iconV[k,iel]]
    jcb[0,1] += dNNNVdr[k]*yV[iconV[k,iel]]
    jcb[1,0] += dNNNVds[k]*xV[iconV[k,iel]]
    jcb[1,1] += dNNNVds[k]*yV[iconV[k,iel]]
jcob = np.linalg.det(jcb)
jcbi = np.linalg.inv(jcb)
for k in range(0,mV):
    dNNNVdx[k]=jcbi[0,0]*dNNNVdr[k]+jcbi[0,1]*dNNNVds[k]
    dNNNVdy[k]=jcbi[1,0]*dNNNVdr[k]+jcbi[1,1]*dNNNVds[k]
\end{lstlisting}



%-----------------------------
\subsection{First Jacobian}


\begin{verbatim}
                J_LP
              --------->                       ---------->
   local (r,s)           linear Polar (r,theta)           cartesian (x,z)
             <---------                        <----------
               J_PL
\end{verbatim}


The Double Jacobian approach uses the standard finite element approach to first map 
from local to linear polar coordinates (i.e. $\uprho,\uptheta$). The first Jacobian for 
a cylindrical (polar) mapping is analogous to the standard Jacobian, where $x$ and $z$ 
are now changed to $\uprho$ and $\uptheta$, respectively.
The global derivatives may be expressed in matrix form as
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial \uprho} \\ \\
\frac{\partial \bN_i}{\partial \uptheta} 
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial r}{\partial \uprho}  & 
\frac{\partial s}{\partial \uprho} \\ \\ 
\frac{\partial r}{\partial \uptheta}  & 
\frac{\partial s}{\partial \uptheta} 
\end{array}
\right)}_{{\bm J}_{LP}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
\label{eq:DJ1}
\end{equation}
where $\bN_i$ are the shape functions and ${\bm J}_{LP}$ 
is the Jacobian of the transformation from local to polar coordinates.

The derivatives of these shape functions with respect to local coordinates $r,s$ (i.e. the rhs vector)
can be computed explicitly since the basis functions are chosen/built for a given element type and formulated
as a function of the local coordinates.
However, the terms of the Jacobian ${\bm J}_{LP}$ cannot be directly computed since 
explicit expressions for $r(\uprho,\uptheta)$ and $s(\uprho,\uptheta)$ do not exist.
A wonderful ``trick'' in finite element programming (discovered by Bruce Irons in the 
mid-60s \cite{eriz68}) is to make use of the inverse coordinate transformation
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial \uprho}{\partial r} & \frac{\partial \uptheta}{\partial r} \\ \\
\frac{\partial \uprho}{\partial s} & \frac{\partial \uptheta}{\partial s} 
\end{array}
\right)}_{{\bm J}_{PL}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial \uprho}  \\ \\
\frac{\partial \bN_i}{\partial \uptheta}
\end{array}
\right)
\label{eq:DJ2}
\end{equation}
where $i{\bm J}_{PL}$ is the Jacobian of the transformation from polar to local coordinates.

From Equations \eqref{eq:DJ1} and \eqref{eq:DJ2}, we have ${\bm J}_{LP}={\bm J}_{PL}^{-1}$.
Using Cramer's rule, the inverse of the Jacobian from polar to local coordinates is given by
\[
{\bm J}_{LP}={\bm J}_{PL}^{-1} = \frac{1}{|{\bm J}_{PL}|} 
\left(
\begin{array}{cc}
\frac{\partial \uptheta}{\partial s} & -\frac{\partial \uptheta}{\partial r} \\ \\
-\frac{\partial \uprho}{\partial s}  & \frac{\partial \uprho}{\partial r}  
\end{array}
\right)
\]

The polar coordinates for each element are related with local coordinates through the shape functions:
\begin{eqnarray}
\uprho(r,s) &=&  \sum_{i=1}^m \bN_i(r,s) \; \uprho_i \nn\\
\uptheta(r,s) &=& \sum_{i=1}^m \bN_i(r,s) \; \uptheta_i \nn
\end{eqnarray}
where $m$ is the number of nodes in the element.
Then
\begin{eqnarray}
\frac{\partial\uprho}{\partial r}(r,s)   &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uprho_i \nn\\
\frac{\partial\uprho}{\partial s}(r,s)   &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i \nn\\
\frac{\partial\uptheta}{\partial r}(r,s) &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uptheta_i \nn\\
\frac{\partial\uptheta}{\partial s}(r,s) &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i 
\end{eqnarray}



%-----------------------------
\subsection{Second jacobian}

The second Jacobian in the DJ method is the {\it analytical} 
mapping from polar coordinates to Cartesian coordinates. The derivatives 
expressed in matrix form are given by
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial \uprho}{\partial x} & \frac{\partial \uptheta}{\partial x}  \\ \\ 
\frac{\partial \uprho}{\partial z} & \frac{\partial \uptheta}{\partial z}  
\end{array}
\right)}_{{\bm J}_{PC}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial \uprho}  \\ \\
\frac{\partial \bN_i}{\partial \uptheta}
\end{array}
\right)
\label{eq:DJ3}
\end{equation}
where ${\bm J}_{PC}$ is the Jacobian from polar to Cartesian coordinates. 
The analytical expressions for $\uptheta(x,z)$ and $\uprho(x,z)$ are known; 
however, it is again easier to use the inverse transformation

\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial \uprho}  \\ \\
\frac{\partial \bN_i}{\partial \uptheta}
\end{array}
\right)
= 
\underbrace{\left(
\begin{array}{cc}
\frac{\partial x}{\partial \uprho}   & 
\frac{\partial z}{\partial \uprho} \\ \\ 
\frac{\partial x}{\partial \uptheta}  & 
\frac{\partial z}{\partial \uptheta}  
\end{array}
\right)}_{{\bm J}_{CP}}
\cdot
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial y} 
\end{array}
\right)
\label{eq:DJ4}
\end{equation}
where ${\bm J}_{CP}$ is the Jacobian from Cartesian to polar coordinates. 
From Equations \eqref{eq:DJ3} and \eqref{eq:DJ4}, ${\bm J}_{PC}={\bm J}_{CP}^{-1} $. The inverse
of the Jacobian from Cartesian to polar coordinates is given by
\[
{\bm J}_{PC}= {\bm J}_{CP}^{-1}=
\frac{1}{|{\bm J}_{CP}|}
\left(
\begin{array}{cc}
\frac{\partial z}{\partial \uptheta}  &  -\frac{\partial z}{\partial \uprho}  \\ \\
-\frac{\partial x}{\partial \uptheta} &  \frac{\partial x}{\partial \uprho}   
\end{array}
\right)
\]
Cartesian coordinates are related with polar coordinates by:
\begin{eqnarray}
x(\uprho,\uptheta) &=& \uprho \cos \uptheta \nn\\
z(\uprho,\uptheta) &=& \uprho \sin \uptheta \nn
\end{eqnarray}
so that 
\begin{eqnarray}
\frac{\partial x}{\partial \uprho} (\uptheta,\uprho) &=&  \cos \uptheta \\
\frac{\partial x}{\partial \uptheta} (\uptheta,\uprho) &=& -\uprho \sin \uptheta \\
\frac{\partial z}{\partial \uprho} (\uptheta,\uprho) &=& \sin \uptheta \\ 
\frac{\partial z}{\partial \uptheta} (\uptheta,\uprho) &=& \uprho \cos \uptheta 
\end{eqnarray}
Then 
\[
{\bm J}_{CP}=
\left(
\begin{array}{cc}
\frac{\partial x}{\partial \uprho}   & 
\frac{\partial z}{\partial \uprho} \\ \\ 
\frac{\partial x}{\partial \uptheta}  & 
\frac{\partial z}{\partial \uptheta}  
\end{array}
\right)
=
\left(
\begin{array}{cc}
\cos \uptheta & \sin \uptheta \\
 -\uprho \sin \uptheta  & \uprho \cos \uptheta 
\end{array}
\right)
\]
with obviously $det({\bm J}_{CP})=\uprho \cos^2 \uptheta+ \uprho \sin^2 \uptheta = \uprho$.

The inverse of the Jacobian from Cartesian coordinates to polar coordinates can then be written 
as a function of polar coordinates:
\begin{equation}
\boxed{
{\bm J}_{CP}^{-1} 
= 
\frac{1}{\uprho}
\left(
\begin{array}{cc}
\uprho\cos\uptheta & -\sin\uptheta \\
\uprho\sin\uptheta & \cos\uptheta
\end{array}
\right)}
\label{eq:DJ6}
\end{equation}
where $\uptheta$ and $\uprho$ are evaluated at each integration point (ip).

Remark: this Jacobian is independent of the choice of basis functions since it is analytical.

%--------------------------------------------------------
\subsection{Combining both}

Making use of the matrix product of the two inverse Jacobians,
global Cartesian derivatives can be expressed as a matrix product of the local 
derivatives in the local to polar and polar to Cartesian coordinate mappings. 
Substituting Equation \eqref{eq:DJ1} into Equation \eqref{eq:DJ3} yields

\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
= 
{\bm J}_{PC} \cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial \uprho}  \\ \\
\frac{\partial \bN_i}{\partial \uptheta}
\end{array}
\right)
=
{\bm J}_{PC} \cdot 
{\bm J}_{LP} \cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
=
%which is equivalent to
%\begin{eqnarray}
%\left(
%\begin{array}{c}
%\frac{\partial \bN_i}{\partial x} \\ \\
%\frac{\partial \bN_i}{\partial y} 
%\end{array}
%\right)
%&=&
{\bm J}_{CP}^{-1} \cdot 
{\bm J}_{PL}^{-1} \cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
\label{eq:DJ123}
\end{equation}
%\end{eqnarray}

Note that the 2d DJ approach will ensure a perfect mapping to the circular-arc edges of the 
elements of a cylindrical annulus mesh.
Any point on the edge of a boundary element of the mesh is mapped to its true position along 
a circular arc.

The major drawback from this is the fact that (as we will see) the Jacobian is no more a polynomial
so special care must be taken with regards to the integration.

%..................................................
\subsection{Linear triangles ($P_1$)}

{\color{red} I need to revisit this.. this is still with rho and theta as in the paper. }

For linear triangles ($P_1$) the basis functions are (see Section~\ref{ss:p1}):
\begin{eqnarray}
\bN_1(r,s)&=&1-r-s \nn\\
\bN_2(r,s)&=&r  \nn\\
\bN_3(r,s)&=&s \nn
\end{eqnarray}
and their derivatives:
\begin{eqnarray}
\frac{\partial\uptheta}{\partial r}(r,s) &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uptheta_i = \uptheta_2-\uptheta_1 = \uptheta_{21}\nn\\
\frac{\partial\uptheta}{\partial s}(r,s) &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i = \uptheta_3-\uptheta_1 = \uptheta_{31}\nn\\
\frac{\partial\uprho}{\partial r}(r,s)   &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uprho_i   = \uprho_2-\uprho_1 = \uprho_{21}\nn\\
\frac{\partial\uprho}{\partial s}(r,s)   &=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i   = \uprho_3-\uprho_1 = \uprho_{31}\nn
\end{eqnarray}
In this case we have 
\begin{equation}
\boxed{
{\bm J}_{LP}={\bm J}_{PL}^{-1} = \frac{1}{\uptheta_{21}\uprho_{31}-\uprho_{21}\uptheta_{31}} 
\left(
\begin{array}{cc}
\uprho_{31} & -\uprho_{21} \\
-\uptheta_{31} & \uptheta_{21}
\end{array}
\right)}
\label{eq:DJ5}
\end{equation}

Substituting Equations \eqref{eq:DJ5} and \eqref{eq:DJ6} into Eq.~\eqref{eq:DJ123}, the analytical expression for this mapping is

\begin{eqnarray}
\left(
\begin{array}{c}    
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
&=&
\frac{1}{\uprho}
\left(
\begin{array}{cc}
\cos \uptheta & \uprho\sin\uptheta \\
-\sin\uptheta & \uprho\cos\uptheta
\end{array}
\right)\cdot
\frac{1}{\uptheta_{21}\uprho_{31}-\uprho_{21}\uptheta_{31}} 
\left(
\begin{array}{cc}
\uprho_{31} & -\uprho_{21} \\
-\uptheta_{31} & \uptheta_{21}
\end{array}
\right)
\nn\\
&=&
\frac{1}{\uptheta_{21}\uprho_{31}-\uprho_{21}\uptheta_{31}} \!
\left(
\begin{array}{cc}
 \frac{\uprho_{31} }{\uprho} \cos\uptheta -\uptheta_{31}\sin\uptheta &  
-\frac{\uprho_{21} }{\uprho} \cos\uptheta +\uptheta_{21}\sin\uptheta \\ \\
-\frac{\uprho_{31} }{\uprho} \sin\uptheta -\uptheta_{31}\cos\uptheta &
 \frac{\uprho_{21} }{\uprho} \sin\uptheta +\uptheta_{21}\cos\uptheta 
\end{array}
\right)
\!
\cdot
\!
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)
\end{eqnarray}
which is Eq. (19) of \textcite{moth20}.
This expression could be problematic if $\uprho=0$ but since it will be evaluated at the 
quadrature points this case is extremely unlikely.


Based on Fig 2 of \textcite{moth20}, we consider an annulus of outer diameter
6371km. Visually from 2A we infer $\uprho_1=4700~\si{\km}$, $\uprho_2=\uprho_3=6371~\si{\km}$, and 
$\uptheta_1=14.5^\circ$, $\uptheta_2=22^\circ$ and $\uptheta_3=0^\circ$.

If quadratic basis functions are used, we define 
$r_4=\frac12(r_1+r_2)$,
$r_5=\frac12(r_2+r_3)$,
$r_6=\frac12(r_3+r_1)$, and likewise for the $\uptheta_{4,5,6}$ values.

We then proceed to generate 1000 random points in the reference triangle and plot their image
in the Cartesian plane, either using the DJ method, a linear mapping $P_1$ or a quadratic mapping $P_2$.
The python code is in {\tt images/mappings/DJ/triangles}.

Unsurprisingly the $P_1$ mapping yields a triangle which 2-3 edge does not conform to the edge of the domain.
The $P_2$ mapping does a much better job and so does the DJ mapping.
\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P1.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P2.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_DJ.pdf}
\end{center}

Let us now generate 1000 points on the 2-3 edge of the reference triangle and study their image 
with the three mappings:
\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P1_boundary.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P2_boundary.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_DJ_boundary.pdf}
\end{center}
We cannot see any different between P2 and DJ. 
Let us now plot the error, i.e. the distance of the image point to the true surface $\uprho=6371$km
as a function of $x$:
\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P1_boundary_error.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_P2_boundary_error.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/triangles/xz_DJ_boundary_error.pdf}
\end{center}
We find that the maximum error for $P_1$ is about 120km, the error for $P_2$ is about 260m, 
and the error for DJ is effectively about $<10^{-9}$m.


\newpage
%..................................................
\subsection{Bilinear quadrilaterals ($Q_1$)}








For linear quadrilaterals ($Q_1$) the basis functions are: 
\begin{eqnarray}
\bN_1(r,s)&=& \frac14(1-r)(1-s) \nn\\
\bN_2(r,s)&=& \frac14(1+r)(1-s) \nn\\
\bN_3(r,s)&=& \frac14(1+r)(1+s) \nn\\
\bN_4(r,s)&=& \frac14(1-r)(1+s) \nn
\end{eqnarray}


\begin{eqnarray}
\frac{\partial\uprho}{\partial r}(r,s)   
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uprho_i   \nn\\
&=&-\frac14 (1-s)\uprho_1 + \frac14 (1-s)\uprho_2 + \frac14 (1+s)\uprho_3 - \frac14 (1+s)\uprho_4 \nn\\
&=& \frac14 (-\uprho_1 + \uprho_2 + \uprho_3 - \uprho_4) 
+\frac14 s (\uprho_1 - \uprho_2 + \uprho_3 - \uprho_4) \nn\\
&=& \tilde{\uprho}_{1234} + \underline{\uprho}_{1234} s
\nn\\
\frac{\partial\uprho}{\partial s}(r,s)   
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i    \nn\\
&=& -\frac14 (1-r)\uprho_1 - \frac14(1+r) \uprho_2 + \frac14(1+r) \uprho_3 + \frac14 (1-r)\uprho_4  \nn\\
&=& \frac14 (-\uprho_1 - \uprho_2 + \uprho_3 + \uprho_4) 
+ \frac14 r (\uprho_1 - \uprho_2 + \uprho_3 - \uprho_4) \nn\\
&=& \bar{\uprho}_{1234} + \underline{\uprho}_{1234} r 
\nn\\
\frac{\partial\uptheta}{\partial r}(r,s) 
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial r}(r,s)\; \uptheta_i \nn\\
&=& -\frac14 (1-s) \uptheta_1 + \frac14 (1-s)\uptheta_2 + \frac14(1+s) \uptheta_3 - \frac14(1+s) \uptheta_4 \nn\\
&=& \frac14 (-\uptheta_1 + \uptheta_2 + \uptheta_3 - \uptheta_4) 
+\frac14 s(\uptheta_1-\uptheta_2+\uptheta_3-\uptheta_4) \nn\\
&=&\tilde{\uptheta}_{1234} + \underline{\uptheta}_{1234}s
\nn\\
\frac{\partial\uptheta}{\partial s}(r,s) 
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i  \nn\\
&=&-\frac14 (1-r)\uptheta_1 - \frac14(1+r) \uptheta_2 + \frac14 (1+r)\uptheta_3 + \frac14(1-r) \uptheta_4 \nn\\
&=& \frac14 (-\uptheta_1 - \uptheta_2 + \uptheta_3 + \uptheta_4)  
+\frac14 r (\uptheta_1 -\uptheta_2  +\uptheta_3 -\uptheta_4 ) \nn\\
&=& \bar{\uptheta}_{1234} + \underline{\uptheta}_{1234}r \nn
\end{eqnarray}
which leads to write
\[
{\bm J}_{PL}=
\left(
\begin{array}{cc}
\frac{\partial \uprho}{\partial r} & \frac{\partial \uptheta}{\partial r} \\ \\
\frac{\partial \uprho}{\partial s} & \frac{\partial \uptheta}{\partial s} 
\end{array}
\right)
=
\left(
\begin{array}{cc}
\tilde{\uprho}_{1234} + \underline{\uprho}_{1234} s 
& \tilde{\uptheta}_{1234} + \underline{\uptheta}_{1234}s \\ \\
\bar{\uprho}_{1234} + \underline{\uprho}_{1234} r  
& \bar{\uptheta}_{1234} + \underline{\uptheta}_{1234}r 
\end{array}
\right)
\]
In this case we have ${\bm J}_{LP}={\bm J}_{PL}^{-1}$ with
\begin{equation}
{\bm J}_{PL}^{-1}= \frac{1}{ 
(\tilde{\uprho}_{1234} + \underline{\uprho}_{1234} s )
(\bar{\uptheta}_{1234} + \underline{\uptheta}_{1234}r )
- 
(\bar{\uprho}_{1234} + \underline{\uprho}_{1234} r )
(\tilde{\uptheta}_{1234} + \underline{\uptheta}_{1234}s )
} 
\left(
\begin{array}{cc}
\bar{\uptheta}_{1234} + \underline{\uptheta}_{1234}r
& -\tilde{\uptheta}_{1234} - \underline{\uptheta}_{1234}s \\ \\
-\bar{\uprho}_{1234} - \underline{\uprho}_{1234} r  
&\tilde{\uprho}_{1234} + \underline{\uprho}_{1234} s 
\end{array}
\right)
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

{\bf SPECIAL CASE}: In the element we have 
$\uptheta_1=\uptheta_2$, $\uptheta_3=\uptheta_4$,
and we define $\tilde{\uptheta}$ such that 
$\frac12(\uptheta_4-\uptheta_1)=\frac12(\uptheta_3-\uptheta_2)=\bar{\uptheta}$.
Likewise,
$\uprho_1=\uprho_4$, $\uprho_2=\uprho_3$ and
we define $\bar{\uprho}$ such that $\frac12(\uprho_2-\uprho_1)=\frac12(\uprho_3-\uprho_4)=\tilde{\uprho}$

\begin{verbatim}
uptheta
|
|
|    4---------3
|    |         |
|    |         |
|    |         |
-----1---------2----------- uprho
\end{verbatim}


In this case:
\begin{eqnarray}
\tilde{\uprho}_{1234}       &=&\frac14\left( -\uprho_1 +\uprho_2 + \uprho_3 -\uprho_4\right) = \tilde{\uprho}\nn\\
\underline{\uprho}_{1234}   &=&\frac14\left(  \uprho_1 -\uprho_2 + \uprho_3 -\uprho_4\right) =0\nn\\
\bar{\uprho}_{1234}         &=&\frac14\left( -\uprho_1 -\uprho_2 + \uprho_3 +\uprho_4\right) =  0 \nn\\
\tilde{\uptheta}_{1234}     &=&\frac14\left( -\uptheta_1 +\uptheta_2 + \uptheta_3 -\uptheta_4 \right) =0\nn\\
\underline{\uptheta}_{1234} &=&\frac14\left(  \uptheta_1 -\uptheta_2 + \uptheta_3 -\uptheta_4 \right)=0\nn\\
\bar{\uptheta}_{1234}       &=&\frac14\left( -\uptheta_1 -\uptheta_2 + \uptheta_3 +\uptheta_4 \right)= \bar{\uptheta}
\end{eqnarray}
so that 
\[
{\bm J}_{PL}=
\left(
\begin{array}{cc}
\frac{\partial \uprho}{\partial r} & \frac{\partial \uptheta}{\partial r} \\ \\
\frac{\partial \uprho}{\partial s} & \frac{\partial \uptheta}{\partial s} 
\end{array}
\right)
=
\left(
\begin{array}{cc}
\tilde{\uprho} & 0 \\
0 & \bar{\uptheta}
\end{array}
\right)
\qquad 
\Rightarrow
\qquad
{\bm J}_{LP}={\bm J}_{PL}^{-1} 
=
\left(
\begin{array}{cc}
\tilde{\uprho}^{-1}& 0 \\
0 & \bar{\uptheta} ^{-1}
\end{array}
\right)
\]
Bringing things together in Eq.~\eqref{eq:DJ123}:
\begin{eqnarray}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
={\bm J}_{CP}^{-1}\cdot {\bm J}_{PL}^{-1}\cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)  
&=&
\frac{1}{\uprho}
\left(
\begin{array}{cc}
\uprho\cos\uptheta & -\sin\uptheta \\
\uprho\sin\uptheta & \cos\uptheta
\end{array}
\right)
\cdot
\left(
\begin{array}{cc}
\tilde{\uprho}^{-1} & 0 \\
0 &  \bar{\uptheta}^{-1}
\end{array}
\right)
\cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)  
\end{eqnarray}

\begin{mdframed}[backgroundcolor=blue!5]
\begin{equation}
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial x} \\ \\
\frac{\partial \bN_i}{\partial z} 
\end{array}
\right)
=
\underbrace{
\left(
\begin{array}{cc}
\tilde{\uprho}^{-1}\cos\uptheta & -\bar{\uptheta}^{-1}\uprho^{-1}\sin\uptheta \\
\tilde{\uprho}^{-1}\sin\uptheta &  \bar{\uptheta}^{-1}\uprho^{-1}\cos\uptheta
\end{array}
\right)
}_{{\bm J}_{LC}}
\cdot 
\left(
\begin{array}{c}
\frac{\partial \bN_i}{\partial r} \\ \\
\frac{\partial \bN_i}{\partial s} 
\end{array}
\right)  
\end{equation}
\end{mdframed}
with
\begin{eqnarray}
det({\bm J}_{LC})
&=&
(\tilde{\uprho}^{-1}\cos\uptheta)
(\bar{\uptheta}^{-1}\uprho^{-1}\cos\uptheta)
+ 
(\tilde{\uprho}^{-1}\sin\uptheta) 
(\bar{\uptheta}^{-1}\uprho^{-1}\sin\uptheta)  \nn\\
&=&
\uprho^{-1}
\left[
\tilde{\uprho}^{-1}
\bar{\uptheta}^{-1}\cos^2\uptheta
+ 
\tilde{\uprho}^{-1}
\bar{\uptheta}^{-1}\sin^2\uptheta  \right] \nn\\
&=&
\uprho^{-1} \tilde{\uprho}^{-1} \bar{\uptheta}^{-1}
\left[
\cos^2\uptheta
+ 
\sin^2\uptheta  \right] \nn\\
&=&
\frac{1}{\uprho \tilde{\uprho}  \bar{\uptheta}}
\end{eqnarray}

If matrix ${\bm A}$ is invertible then ${\bm A}\cdot {\bm A}^{-1}={\bm 1}$,
and since $det({\bm A}\cdot {\bm B}) = det({\bm A}) det ({\bm B})$, then
$det({\bm A}\cdot {\bm A}^{-1})= det({\bm A})\; det ({\bm A}^{-1}) =1$.
This means that
\[
det({\bm J}_{CL})
=det({\bm J}_{LC}^{-1})
=[det({\bm J}_{LC})]^{-1}
=  \uprho \tilde{\uprho}  \bar{\uptheta}
\]
Finally, 
from Cramer's rule\footnote{\url{https://en.wikipedia.org/wiki/Cramers_rule}},
we obtain:
\begin{eqnarray}
{\bm J}_{CL} = 
{\bm J}_{LC}^{-1} &=& 
\frac{1}{det({\bm J}_{LC})} 
\left(
\begin{array}{cc}
\bar{\uptheta}^{-1}\uprho^{-1}\cos\uptheta & 
\bar{\uptheta}^{-1}\uprho^{-1}\sin\uptheta \\
-\tilde{\uprho}^{-1}\sin\uptheta 
&\tilde{\uprho}^{-1}\cos\uptheta 
\end{array}
\right) \nn\\
&=&
\uprho \tilde{\uprho}  \bar{\uptheta}
\left(
\begin{array}{cc}
\bar{\uptheta}^{-1}\uprho^{-1}\cos\uptheta & 
\bar{\uptheta}^{-1}\uprho^{-1}\sin\uptheta \\
-\tilde{\uprho}^{-1}\sin\uptheta 
&\tilde{\uprho}^{-1}\cos\uptheta 
\end{array}
\right) \nn\\
&=&
\tilde{\uprho}  \bar{\uptheta}
\left(
\begin{array}{cc}
\bar{\uptheta}^{-1}\cos\uptheta & 
\bar{\uptheta}^{-1}\sin\uptheta \\
-\uprho\tilde{\uprho}^{-1}\sin\uptheta 
&\uprho\tilde{\uprho}^{-1}\cos\uptheta 
\end{array}
\right) \nn\\
&=&
\left(
\begin{array}{cc}
\tilde{\uprho}\cos\uptheta & 
\tilde{\uprho}\sin\uptheta \\
-\uprho\bar{\uptheta}\sin\uptheta 
&\uprho\bar{\uptheta}\cos\uptheta 
\end{array}
\right) 
\end{eqnarray}
and of course we recover $det({\bm J}_{CL})=\uprho \bar{\uptheta}  \tilde{\uprho}$.
Finally:
\begin{mdframed}[backgroundcolor=blue!5]
\[
{\bm J}_{CL} = 
\left(
\begin{array}{cc}
\tilde{\uprho}\cos\uptheta & 
\tilde{\uprho}\sin\uptheta \\
-\uprho\bar{\uptheta}\sin\uptheta 
&\uprho\bar{\uptheta}\cos\uptheta 
\end{array}
\right) 
\]
\end{mdframed}





\vspace{1cm}

Note that the area of such element can easily be computed analytically:
\[
{\cal A}_e 
= \iint_{\Omega_e} \uprho d\uprho d\uptheta 
= \int_{\uprho_1}^{\uprho_3}\int_{\uptheta_3}^{\uptheta_1} \uprho d\uprho d\uptheta 
= (\uptheta_1-\uptheta_3) \frac12 (\uprho_3^2-\uprho_1^2)
\]


We can now compute the same area but using a numerical quadrature:

%We have $\bar{\uprho}=\frac12 (\uprho_4-\uprho_1)=\frac12 \delta\uprho$ and
%$\tilde{\uptheta}=\frac12 (\uptheta_2-\uptheta_1) = \frac12 \delta \uptheta$.

(iq: in theta direction, jq in r direction) sum w= 2 

\begin{eqnarray}
{\cal A}_e
&=&\iint_{\Omega_e} dV  \nn\\
&=&\sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} det({\bm J})|_{i_q} \nn\\
&=&\sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} ( \uprho \bar{\uprho} \tilde{\uptheta} ) \nn\\
&=& \tilde{\uptheta} \bar{\uprho}  \sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} \uprho_{iq,jq} \nn\\
&=& \tilde{\uptheta}   \bar{\uprho} \;  2  \sum_{jq=1}^{n_q}  w_{jq} \uprho_{jq} 
\end{eqnarray}

We have, since $\uprho = mr+p $ with $p=\frac12 (\uprho_1+\uprho_3)$ in the element (see Example 2 in Section~\ref{ss:quad:examples}):
\[ 
\sum_{jq=1}^{n_q}  w_{jq} \uprho_{jq} = \frac12 (\uprho_1+\uprho_3)  \cdot 2 = \uprho_1+\uprho_3
\]
so that
\begin{eqnarray}
{\cal A}_e
&=&\tilde{\uptheta}   \bar{\uprho}   2 (\uprho_1+\uprho_3) \nn\\
&=&\frac12 (\uptheta_3-\uptheta_1)  \frac12 (\uprho_3-\uprho_1)  2 (\uprho_1+\uprho_3) \nn\\
&=&\frac12 (\uptheta_3-\uptheta_1)   (\uprho_3^2-\uprho_1^2) 
\end{eqnarray}
which is indeed the area of an element.













\vspace{.5cm}

Let us consider an annulus with inner radius $R_1$ and outer radius $R_2$. Let us assume it is tesselated 
by means of non-overlapping elements, all characterised by the same $\delta\uprho$ and $\delta\uptheta$ 
dimensions.


\begin{eqnarray}
{\cal A}
&=&\iint_\Omega dV  \nn\\
&=&\sum_e \iint_{\Omega_e} dV  \nn\\
&=&\sum_e {\cal A}_e   \nn\\
&=&\sum_e \sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} det({\bm J})|_{i_q} \nn\\
&=&\sum_e \sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} (\uprho  \frac12 \delta \uptheta  \frac12 \delta\uprho ) \nn\\
&=&\sum_e  (\frac12 \delta \uptheta  \frac12 \delta\uprho)_e  \sum_{iq=1}^{n_q} \sum_{jq=1}^{n_q}   w_{iq} w_{jq} \uprho_{iq,jq} \nn\\
&=&\sum_e  (\frac12 \delta \uptheta  \frac12 \delta\uprho)_e  2  \sum_{jq=1}^{n_q}  w_{jq} \uprho_{jq} \nn\\
\end{eqnarray}

FINISH/CORRECT


\newpage 
We can carry out the same exercise as before.
The python code is in {\tt images/mappings/DJ/quadrilaterals}.
The element is defined by 
$\uptheta_1=\uptheta_4=10^\circ$,
$\uptheta_2=\uptheta_3=25^\circ$,
$\uprho_1=\uprho_2=4700~\si{\km}$,
$\uprho_3=\uprho_4=6371~\si{\km}$.

\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P1.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P2.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_DJ.pdf}
\end{center}

\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P1_boundary.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P2_boundary.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_DJ_boundary.pdf}
\end{center}

\begin{center}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P1_boundary_error.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_P2_boundary_error.pdf}
\includegraphics[width=5.7cm]{images/mappings/DJ/quadrilaterals/xz_DJ_boundary_error.pdf}
\end{center}


%.................................................
\subsubsection{Quadratic quadrilaterals ($Q_2$)}
The layout of the nodes is as follows:
\begin{verbatim}
4 7 3
8 9 6
1 5 2
\end{verbatim}
The basis functions are given by 
\begin{eqnarray}
\bN_1(r,s)&=& \frac{1}{2}r(r-1)  \frac{1}{2}s(s-1)\nonumber\\
\bN_2(r,s)&=& \frac{1}{2}r(r+1)  \frac{1}{2}s(s-1)\nonumber\\
\bN_3(r,s)&=& \frac{1}{2}r(r+1)  \frac{1}{2}s(s+1)\nonumber\\
\bN_4(r,s)&=& \frac{1}{2}r(r-1)  \frac{1}{2}s(s+1)\nonumber\\
\bN_5(r,s)&=&     (1-r^2)  \frac{1}{2}s(s-1)\nonumber\\
\bN_6(r,s)&=& \frac{1}{2}r(r+1)      (1-s^2)\nonumber\\
\bN_7(r,s)&=&     (1-r^2)  \frac{1}{2}s(s+1)\nonumber\\
\bN_8(r,s)&=& \frac{1}{2}r(r-1)      (1-s^2)\nonumber\\
\bN_9(r,s)&=&     (1-r^2)      (1-s^2)\nonumber
\end{eqnarray}
with the following derivatives:
\begin{align}
\frac{\partial \bN_1}{\partial r}&= \frac{1}{2}(2r-1)  \frac{1}{2}s(s-1) &
\frac{\partial \bN_1}{\partial s}&= \frac{1}{2}r(r-1)  \frac{1}{2}(2s-1)\nonumber\\
\frac{\partial \bN_2}{\partial r}&= \frac{1}{2}(2r+1)  \frac{1}{2}s(s-1) &
\frac{\partial \bN_2}{\partial s}&= \frac{1}{2}r(r+1)  \frac{1}{2}(2s-1)\nonumber\\
\frac{\partial \bN_3}{\partial r}&= \frac{1}{2}(2r+1)  \frac{1}{2}s(s+1) &
\frac{\partial \bN_3}{\partial s}&= \frac{1}{2}r(r+1)  \frac{1}{2}(2s+1)\nonumber\\
\frac{\partial \bN_4}{\partial r}&= \frac{1}{2}(2r-1)  \frac{1}{2}s(s+1) &
\frac{\partial \bN_4}{\partial s}&= \frac{1}{2}r(r-1)  \frac{1}{2}(2s+1)\nonumber\\
\frac{\partial \bN_5}{\partial r}&=       (-2r)  \frac{1}{2}s(s-1) &
\frac{\partial \bN_5}{\partial s}&=     (1-r^2)  \frac{1}{2}(2s-1)\nonumber\\
\frac{\partial \bN_6}{\partial r}&= \frac{1}{2}(2r+1)     (1-s^2)&
\frac{\partial \bN_6}{\partial s}&= \frac{1}{2}r(r+1)        (-2s)\nonumber\\
\frac{\partial \bN_7}{\partial r}&=       (-2r)  \frac{1}{2}s(s+1)&
\frac{\partial \bN_7}{\partial s}&=     (1-r^2)  \frac{1}{2}(2s+1)\nonumber\\
\frac{\partial \bN_8}{\partial r}&= \frac{1}{2}(2r-1)     (1-s^2)&
\frac{\partial \bN_8}{\partial s}&= \frac{1}{2}r(r-1)        (-2s)\nonumber\\
\frac{\partial \bN_9}{\partial r}&=       (-2r)     (1-s^2)&
\frac{\partial \bN_9}{\partial s}&=     (1-r^2)        (-2s)\nonumber
\end{align}

We go straight for the special case: 
\begin{itemize}
\item $\uprho_1=\uprho_2=\uprho_5$,
\item $\uprho_6=\uprho_8=\uprho_9$,
\item $\uprho_3=\uprho_4=\uprho_7$,
\item $\uptheta_1=\uptheta_4=\uptheta_8$,
\item $\uptheta_5=\uptheta_7=\uptheta_9$,
\item $\uptheta_2=\uptheta_3=\uptheta_6$,
\item $\frac12(\uptheta_2-\uptheta_1)=\frac12(\uptheta_3-\uptheta_4)=\frac12(\uptheta_6-\uptheta_8)=\tilde{\uptheta}$,
\item $\frac12(\uprho_4-\uprho_1)=\frac12(\uprho_3-\uprho_2)=\frac12(\uprho_7-\uprho_5)=\bar{\uprho}$ \nn
\end{itemize}
We start with
\begin{eqnarray}
\frac{\partial\uptheta}{\partial r}(r,s) 
&=& \sum_i \frac{\partial \bN_i}{\partial r}(r,s)  \uptheta_i \nn\\
&=& \sum_{i=1,4,8} \frac{\partial \bN_i}{\partial r}(r,s)  \uptheta_i
+\sum_{i=5,7,9} \frac{\partial \bN_i}{\partial r}(r,s)  \uptheta_i
+\sum_{i=2,3,6} \frac{\partial \bN_i}{\partial r}(r,s)  \uptheta_i \nn\\
&=& \uptheta_1\sum_{i=1,4,8} \frac{\partial \bN_i}{\partial r}(r,s) 
+\uptheta_5\sum_{i=5,7,9} \frac{\partial \bN_i}{\partial r}(r,s)  
+\uptheta_2\sum_{i=2,3,6} \frac{\partial \bN_i}{\partial r}(r,s)  
\end{eqnarray}
We find that 
\begin{eqnarray}
\sum_{i=1,4,8} \frac{\partial \bN_i}{\partial r}(r,s)
&=& \frac{1}{2}(2r-1)  \frac{1}{2}s(s-1)
+ \frac{1}{2}(2r-1)  \frac{1}{2}s(s+1) 
+ \frac{1}{2}(2r-1)     (1-s^2) \nn\\
&=& \frac{1}{2}(2r-1) \left[ \frac{1}{2}s(s-1) + \frac{1}{2}s(s+1) +   (1-s^2)\right] \nn\\
&=& \frac{1}{2}(2r-1) \left[ s^2 +   (1-s^2)\right] \nn\\
&=& \frac{1}{2}(2r-1) 
\nn\\
\sum_{i=5,7,9} \frac{\partial \bN_i}{\partial r}(r,s) 
&=& -2r \frac{1}{2}s(s-1)
-2r \frac{1}{2}s(s+1) 
-2r    (1-s^2) \nn\\
&=& -2r \nn\\
\sum_{i=2,3,6} \frac{\partial \bN_i}{\partial r}(r,s) 
&=& \frac{1}{2}(2r+1)  \frac{1}{2}s(s-1)
+ \frac{1}{2}(2r+1)  \frac{1}{2}s(s+1) 
+ \frac{1}{2}(2r+1)     (1-s^2) \nn\\
&=& \frac{1}{2}(2r+1)  \nn
\end{eqnarray}
Then 
\begin{eqnarray}
\frac{\partial\uptheta}{\partial r}(r,s) 
&=& \uptheta_1\sum_{i=1,4,8} \frac{\partial \bN_i}{\partial r}(r,s) 
+\uptheta_5\sum_{i=5,7,9} \frac{\partial \bN_i}{\partial r}(r,s)  
+\uptheta_2\sum_{i=2,3,6} \frac{\partial \bN_i}{\partial r}(r,s)  \nn\\
&=&  \frac{1}{2}(2r-1) \uptheta_1 -2r \uptheta_5 + \frac{1}{2}(2r+1) \uptheta_2
\end{eqnarray}
Using $\uptheta_5=\frac12 (\uptheta_1+\uptheta_2)$, then
\begin{eqnarray}
\frac{\partial\uptheta}{\partial r}(r,s) 
&=&  \frac{1}{2}(2r-1) \uptheta_1 -2r \uptheta_5 + \frac{1}{2}(2r+1) \uptheta_2 \nn\\
&=&  \frac{1}{2}(2r-1) \uptheta_1 -2r \frac12 (\uptheta_1+\uptheta_2) + \frac{1}{2}(2r+1) \uptheta_2 \nn\\
&=& \frac12 \left[ (2r-1) \uptheta_1 -2r \uptheta_1 -2r\uptheta_2 + (2r+1) \uptheta_2  \right] \nn\\
&=& \frac12 (\uptheta_2-\uptheta_1) \nn\\
&=& \tilde{\uptheta}
\end{eqnarray}
Then we compute 
\begin{eqnarray}
\frac{\partial\uptheta}{\partial s}(r,s) 
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i  \nn\\ 
&=&\sum_{i=1,4,8}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i  
+  \sum_{i=5,7,9}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i  
+  \sum_{i=2,3,6}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uptheta_i  \nn\\ 
&=& \uptheta_1 \sum_{i=1,4,8}^m \frac{\partial\bN_i}{\partial s}(r,s) 
+   \uptheta_5 \sum_{i=5,7,9}^m \frac{\partial\bN_i}{\partial s}(r,s) 
+   \uptheta_2 \sum_{i=2,3,6}^m \frac{\partial\bN_i}{\partial s}(r,s) 
\end{eqnarray}
We find that 
\begin{eqnarray}
\sum_{i=1,4,8} \frac{\partial \bN_i}{\partial s}(r,s)
&=& \frac{1}{2}r(r-1)  \frac{1}{2}(2s-1) + 
\frac{1}{2}r(r-1)  \frac{1}{2}(2s+1) +
\frac{1}{2}r(r-1)        (-2s)  \nn\\
&=& \frac{1}{2}r(r-1) \left[ \frac{1}{2}(2s-1)+   \frac{1}{2}(2s+1) -2s\right] \nn\\
&=& 0 \nn\\
\sum_{i=5,7,9} \frac{\partial \bN_i}{\partial s}(r,s)
&=&   (1-r^2)  \frac{1}{2}(2s-1) +      (1-r^2)  \frac{1}{2}(2s+1) +  (1-r^2)   +     (-2s)   \nn\\
&=& 0 \nn\\
\sum_{i=2,3,6} \frac{\partial \bN_i}{\partial s}(r,s)
&=&   \frac{1}{2}r(r+1)  \frac{1}{2}(2s-1) + \frac{1}{2}r(r+1)  \frac{1}{2}(2s+1) \frac{1}{2}r(r+1)  (-2s) \nn\\
&=& 0 
\end{eqnarray}
so that 
\[
\frac{\partial\uptheta}{\partial s}(r,s)  =0
\]
At this stage we are reasonably sure that the components of the Jacobian ${\bm J}_{PL}$ we are computing
for this $Q_2$ element will turn out to be the same at thos obtained for the $Q_1$ element. 
Just to be on the safe side, we soldier on:

\begin{eqnarray}
\frac{\partial\uprho}{\partial s}(r,s) 
&=& \sum_{i=1}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i  \nn\\ 
&=&\sum_{i=1,2,5}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i  
+  \sum_{i=6,8,9}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i  
+  \sum_{i=3,4,7}^m \frac{\partial\bN_i}{\partial s}(r,s)\; \uprho_i  \nn\\ 
&=&\uprho_1\sum_{i=1,2,5}^m \frac{\partial\bN_i}{\partial s}(r,s)
+  \uprho_6\sum_{i=6,8,9}^m \frac{\partial\bN_i}{\partial s}(r,s)
+  \uprho_3\sum_{i=3,4,7}^m \frac{\partial\bN_i}{\partial s}(r,s) 
\end{eqnarray}
with
\begin{eqnarray}
\sum_{i=1,2,5}^m \frac{\partial\bN_i}{\partial s}(r,s)
&=&  \frac{1}{2}r(r-1)  \frac{1}{2}(2s-1) + \frac{1}{2}r(r+1)  \frac{1}{2}(2s-1) +   (1-r^2)  \frac{1}{2}(2s-1) \nn\\
&=& \frac{1}{2}(2s-1) \left[ \frac{1}{2}r(r-1)   + \frac{1}{2}r(r+1)  +   (1-r^2)  \right] \nn\\
&=& \frac{1}{2}(2s-1)  \nn\\
\sum_{i=6,8,9}^m \frac{\partial\bN_i}{\partial s}(r,s)
&=& \frac{1}{2}r(r+1)        (-2s) + \frac{1}{2}r(r-1)        (-2s) +    (1-r^2)        (-2s)  \nn\\
&=& -2s \left[ \frac{1}{2}r(r+1)    + \frac{1}{2}r(r-1)    +    (1-r^2)      \right]\nn\\
&=& -2s  \nn\\
\sum_{i=3,4,7}^m \frac{\partial\bN_i}{\partial s}(r,s)
&=& \frac{1}{2}(2s+1)  \left[ \frac{1}{2}r(r+1)  +   \frac{1}{2}r(r-1)   +  (1-r^2)  \right]\nn\\
&=& \frac{1}{2}(2s+1)  \nn
\end{eqnarray}
In the end
\begin{eqnarray}
\frac{\partial\uprho}{\partial s}(r,s) 
&=&\uprho_1\sum_{i=1,2,5}^m \frac{\partial\bN_i}{\partial s}(r,s)
+  \uprho_6\sum_{i=6,8,9}^m \frac{\partial\bN_i}{\partial s}(r,s)
+  \uprho_3\sum_{i=3,4,7}^m \frac{\partial\bN_i}{\partial s}(r,s) \nn\\
&=& \uprho_1  \frac{1}{2}(2s-1)  + \uprho_6 (-2s) + \uprho_3 \frac{1}{2}(2s+1) \nn
\end{eqnarray}
With $\uprho_6=\frac12 (\uprho_1+\uprho_3)$ we find
\begin{eqnarray}
\frac{\partial\uprho}{\partial s}(r,s) 
&=& \uprho_1  \frac{1}{2}(2s-1)  + \frac12 (\uprho_1+\uprho_3) (-2s) + \uprho_3 \frac{1}{2}(2s+1) \nn\\
&=& \frac12 \left[ \uprho_1 (2s-1)  + (\uprho_1+\uprho_3) (-2s) + \uprho_3 (2s+1)\right] \nn\\
&=& \frac12 (\uprho_3-\uprho_1) \nn\\
&=& \bar{\uprho} \nn
\end{eqnarray}
Case closed, we find here too that 
\[
{\bm J}_{PL}=
\left(
\begin{array}{cc}
\frac{\partial \uptheta}{\partial r}  & 
\frac{\partial \uprho}{\partial r}  \\ \\
\frac{\partial \uptheta}{\partial s}  & 
\frac{\partial \uprho}{\partial s}
\end{array}
\right)
=
\left(
\begin{array}{cc}
\tilde{\uptheta}  &  0 \\\\
0 & \bar{\uprho}
\end{array}
\right)
\]



