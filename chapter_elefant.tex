\section{ELEFANT} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%





























\newpage
%---------------------------------------------------
\subsection{$Q_1\times P_0$ cartesian identity card}

Check Section~\ref{sec:sparse_storage}

\begin{small}
\begin{verbatim}
spaceV='__Q1'
spaceP='__Q0'
nelx=3
nely=2
nel=6
NV=12
NP=6

9------10------11------12     -------------------------
|       |       |       |     |       |       |       |
|       |       |       |     |   4   |   5   |   6   |
|       |       |       |     |       |       |       |
5-------6-------7-------8     |-------|-------|-------|
|       |       |       |     |       |       |       |
|       |       |       |     |   1   |   2   |   3   |
|       |       |       |     |       |       |       | 
1-------2-------3-------4     ------------------------- 

elt: 1  | iconV  1  2   6   5 iconP  1
elt: 2  | iconV  2  3   7   6 iconP  2
elt: 3  | iconV  3  4   8   7 iconP  3
elt: 4  | iconV  5  6  10   9 iconP  4
elt: 5  | iconV  6  7  11  10 iconP  5
elt: 6  | iconV  7  8  12  11 iconP  6

node   1 belongs to  1  elts | 1           0           0           0
node   2 belongs to  2  elts | 1           2           0           0
node   3 belongs to  2  elts | 2           3           0           0
node   4 belongs to  1  elts | 3           0           0           0
node   5 belongs to  2  elts | 1           4           0           0
node   6 belongs to  4  elts | 1           2           4           5
node   7 belongs to  4  elts | 2           3           5           6
node   8 belongs to  2  elts | 3           6           0           0
node   9 belongs to  1  elts | 4           0           0           0
node  10 belongs to  2  elts | 4           5           0           0
node  11 belongs to  2  elts | 5           6           0           0
node  12 belongs to  1  elts | 6           0           0           0

\end{verbatim}
\end{small}

Each elemental K matrix is 8x8

\begin{small}
\[
\begin{array}{cccccccccccccccccccccccccccc}
& u_1 & u_2 & u_3 & u_4 & u_5 & u_6 &
u_7 & u_8 & u_9 & u_{10} & u_{11} & u_{12} 
& v_1 & v_2 & v_3 & v_4 & v_5 & v_6 &
v_7 & v_8 & v_9 & v_{10} & v_{11} & v_{12} \\
u_1 & * & * & && * & * &&&&&&& * & * &&& * & *\\
u_2 & * & * & && * & * &&&&&&& * & * &&& * & *\\
_3
\end{array}
\]
\end{small}










\newpage
%---------------------------------------------------
\subsection{$Q_1\times P_0$ annulus identity card}

\begin{center}
\includegraphics[width=7cm]{images/ELEFANT/annulus_Q1}
\end{center}




\newpage
%---------------------------------------------------
\subsection{$Q_2\times Q_1$ annulus identity card}

\begin{small}
\begin{verbatim}
spaceV='__Q2'
spaceP='__Q1'
nelr=2
nelphi=8
nel=8
NV=80
NP=24
\end{verbatim}
\end{small}

\begin{center}
\includegraphics[width=7cm]{images/ELEFANT/annulus_Q2}
\end{center}

\begin{verbatim}

                 25           15
                 24         14
                 23       13
                 22     12
                 21   11
                  |     
                  |
45 44 43 42 41----+------1-2-3-4-5
\end{verbatim}




\begin{small}
\begin{verbatim}
V node     1 belongs to  2 elts:       1    15     0     0     0     0     0     0
V node     2 belongs to  2 elts:       1    15     0     0     0     0     0     0
V node     3 belongs to  4 elts:       1     2    15    16     0     0     0     0
V node     4 belongs to  2 elts:       2    16     0     0     0     0     0     0
V node     5 belongs to  2 elts:       2    16     0     0     0     0     0     0
V node     6 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node     7 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node     8 belongs to  2 elts:       1     2     0     0     0     0     0     0
V node     9 belongs to  1 elts:       2     0     0     0     0     0     0     0
V node    10 belongs to  1 elts:       2     0     0     0     0     0     0     0
V node    11 belongs to  2 elts:       1     3     0     0     0     0     0     0
V node    12 belongs to  2 elts:       1     3     0     0     0     0     0     0
V node    13 belongs to  4 elts:       1     2     3     4     0     0     0     0
V node    14 belongs to  2 elts:       2     4     0     0     0     0     0     0
V node    15 belongs to  2 elts:       2     4     0     0     0     0     0     0
V node    16 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node    17 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node    18 belongs to  2 elts:       3     4     0     0     0     0     0     0
V node    19 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    20 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    21 belongs to  2 elts:       3     5     0     0     0     0     0     0
V node    22 belongs to  2 elts:       3     5     0     0     0     0     0     0
V node    23 belongs to  4 elts:       3     4     5     6     0     0     0     0
V node    24 belongs to  2 elts:       4     6     0     0     0     0     0     0
V node    25 belongs to  2 elts:       4     6     0     0     0     0     0     0
V node    26 belongs to  1 elts:       5     0     0     0     0     0     0     0
V node    27 belongs to  1 elts:       5     0     0     0     0     0     0     0
V node    28 belongs to  2 elts:       5     6     0     0     0     0     0     0
V node    29 belongs to  1 elts:       6     0     0     0     0     0     0     0
V node    30 belongs to  1 elts:       6     0     0     0     0     0     0     0
V node    31 belongs to  2 elts:       5     7     0     0     0     0     0     0
V node    32 belongs to  2 elts:       5     7     0     0     0     0     0     0
V node    33 belongs to  4 elts:       5     6     7     8     0     0     0     0
V node    34 belongs to  2 elts:       6     8     0     0     0     0     0     0
V node    35 belongs to  2 elts:       6     8     0     0     0     0     0     0
V node    36 belongs to  1 elts:       7     0     0     0     0     0     0     0
V node    37 belongs to  1 elts:       7     0     0     0     0     0     0     0
V node    38 belongs to  2 elts:       7     8     0     0     0     0     0     0
V node    39 belongs to  1 elts:       8     0     0     0     0     0     0     0
V node    40 belongs to  1 elts:       8     0     0     0     0     0     0     0
V node    41 belongs to  2 elts:       7     9     0     0     0     0     0     0
V node    42 belongs to  2 elts:       7     9     0     0     0     0     0     0
V node    43 belongs to  4 elts:       7     8     9    10     0     0     0     0
V node    44 belongs to  2 elts:       8    10     0     0     0     0     0     0
V node    45 belongs to  2 elts:       8    10     0     0     0     0     0     0
V node    46 belongs to  1 elts:       9     0     0     0     0     0     0     0
V node    47 belongs to  1 elts:       9     0     0     0     0     0     0     0
V node    48 belongs to  2 elts:       9    10     0     0     0     0     0     0
V node    49 belongs to  1 elts:      10     0     0     0     0     0     0     0
V node    50 belongs to  1 elts:      10     0     0     0     0     0     0     0
V node    51 belongs to  2 elts:       9    11     0     0     0     0     0     0
V node    52 belongs to  2 elts:       9    11     0     0     0     0     0     0
V node    53 belongs to  4 elts:       9    10    11    12     0     0     0     0
V node    54 belongs to  2 elts:      10    12     0     0     0     0     0     0
V node    55 belongs to  2 elts:      10    12     0     0     0     0     0     0
V node    56 belongs to  1 elts:      11     0     0     0     0     0     0     0
V node    57 belongs to  1 elts:      11     0     0     0     0     0     0     0
V node    58 belongs to  2 elts:      11    12     0     0     0     0     0     0
V node    59 belongs to  1 elts:      12     0     0     0     0     0     0     0
V node    60 belongs to  1 elts:      12     0     0     0     0     0     0     0
V node    61 belongs to  2 elts:      11    13     0     0     0     0     0     0
V node    62 belongs to  2 elts:      11    13     0     0     0     0     0     0
V node    63 belongs to  4 elts:      11    12    13    14     0     0     0     0
V node    64 belongs to  2 elts:      12    14     0     0     0     0     0     0
V node    65 belongs to  2 elts:      12    14     0     0     0     0     0     0
V node    66 belongs to  1 elts:      13     0     0     0     0     0     0     0
V node    67 belongs to  1 elts:      13     0     0     0     0     0     0     0
V node    68 belongs to  2 elts:      13    14     0     0     0     0     0     0
V node    69 belongs to  1 elts:      14     0     0     0     0     0     0     0
V node    70 belongs to  1 elts:      14     0     0     0     0     0     0     0
V node    71 belongs to  2 elts:      13    15     0     0     0     0     0     0
V node    72 belongs to  2 elts:      13    15     0     0     0     0     0     0
V node    73 belongs to  4 elts:      13    14    15    16     0     0     0     0
V node    74 belongs to  2 elts:      14    16     0     0     0     0     0     0
V node    75 belongs to  2 elts:      14    16     0     0     0     0     0     0
V node    76 belongs to  1 elts:      15     0     0     0     0     0     0     0
V node    77 belongs to  1 elts:      15     0     0     0     0     0     0     0
V node    78 belongs to  2 elts:      15    16     0     0     0     0     0     0
V node    79 belongs to  1 elts:      16     0     0     0     0     0     0     0
V node    80 belongs to  1 elts:      16     0     0     0     0     0     0     0

P node     1 belongs to  2 elts:       1    15     0     0     0     0     0     0
P node     2 belongs to  4 elts:       1     2    15    16     0     0     0     0
P node     3 belongs to  2 elts:       2    16     0     0     0     0     0     0
P node     4 belongs to  2 elts:       1     3     0     0     0     0     0     0
P node     5 belongs to  4 elts:       1     2     3     4     0     0     0     0
P node     6 belongs to  2 elts:       2     4     0     0     0     0     0     0
P node     7 belongs to  2 elts:       3     5     0     0     0     0     0     0
P node     8 belongs to  4 elts:       3     4     5     6     0     0     0     0
P node     9 belongs to  2 elts:       4     6     0     0     0     0     0     0
P node    10 belongs to  2 elts:       5     7     0     0     0     0     0     0
P node    11 belongs to  4 elts:       5     6     7     8     0     0     0     0
P node    12 belongs to  2 elts:       6     8     0     0     0     0     0     0
P node    13 belongs to  2 elts:       7     9     0     0     0     0     0     0
P node    14 belongs to  4 elts:       7     8     9    10     0     0     0     0
P node    15 belongs to  2 elts:       8    10     0     0     0     0     0     0
P node    16 belongs to  2 elts:       9    11     0     0     0     0     0     0
P node    17 belongs to  4 elts:       9    10    11    12     0     0     0     0
P node    18 belongs to  2 elts:      10    12     0     0     0     0     0     0
P node    19 belongs to  2 elts:      11    13     0     0     0     0     0     0
P node    20 belongs to  4 elts:      11    12    13    14     0     0     0     0
P node    21 belongs to  2 elts:      12    14     0     0     0     0     0     0
P node    22 belongs to  2 elts:      13    15     0     0     0     0     0     0
P node    23 belongs to  4 elts:      13    14    15    16     0     0     0     0
P node    24 belongs to  2 elts:      14    16     0     0     0     0     0     0
\end{verbatim}
\end{small}














\newpage
%---------------------------------------------------
\subsection{$Q_2 \times Q_1$ cartesian identity card}
\begin{small}
\begin{verbatim}
spaceV='__Q2'
spaceP='__Q1'
nelx=3
nely=2
nel=6
NV=7*5=35
NP=12

        V nodes                       elements                     P nodes 

29--30--31--32--33--34--35    -------------------------    9------10------11------12
|       |       |       |     |       |       |       |    |       |       |       |
22  23  24  25  26  27  28    |   4   |   5   |   6   |    |       |       |       |
|       |       |       |     |       |       |       |    |       |       |       |
15--16--17--18--19--20--21    |-------|-------|-------|    5-------6-------7-------8
|       |       |       |     |       |       |       |    |       |       |       |
8   9   10  11  12  13  14    |   1   |   2   |   3   |    |       |       |       |
|       |       |       |     |       |       |       |    |       |       |       |
1---2---3---4---5---6---7     -------------------------    1-------2-------3-------4

elt: 1  | iconV  1 2  3   8  9  10 15 16 17 iconP 1 2 6  5
elt: 2  | iconV  3 4  5   10 11 12 17 18 19 iconP 2 3 7  6
elt: 3  | iconV  5 6  7   12 13 14 19 20 21 iconP 3 4 8  7
elt: 4  | iconV  15 16 17 22 23 24 29 30 31 iconP 5 6 10 9
elt: 5  | iconV  17 18 19 24 25 26 31 32 33 iconP 6 7 11 10
elt: 6  | iconV  19 20 21 26 27 28 33 34 35 iconP 7 8 12 11

a node belongs to at most 4 elements:

V node     1 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node     2 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node     3 belongs to  2 elts:       1     2     0     0     0     0     0     0
V node     4 belongs to  1 elts:       2     0     0     0     0     0     0     0
V node     5 belongs to  2 elts:       2     3     0     0     0     0     0     0
V node     6 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node     7 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node     8 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node     9 belongs to  1 elts:       1     0     0     0     0     0     0     0
V node    10 belongs to  2 elts:       1     2     0     0     0     0     0     0
V node    11 belongs to  1 elts:       2     0     0     0     0     0     0     0
V node    12 belongs to  2 elts:       2     3     0     0     0     0     0     0
V node    13 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node    14 belongs to  1 elts:       3     0     0     0     0     0     0     0
V node    15 belongs to  2 elts:       1     4     0     0     0     0     0     0
V node    16 belongs to  2 elts:       1     4     0     0     0     0     0     0
V node    17 belongs to  4 elts:       1     2     4     5     0     0     0     0
V node    18 belongs to  2 elts:       2     5     0     0     0     0     0     0
V node    19 belongs to  4 elts:       2     3     5     6     0     0     0     0
V node    20 belongs to  2 elts:       3     6     0     0     0     0     0     0
V node    21 belongs to  2 elts:       3     6     0     0     0     0     0     0
V node    22 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    23 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    24 belongs to  2 elts:       4     5     0     0     0     0     0     0
V node    25 belongs to  1 elts:       5     0     0     0     0     0     0     0
V node    26 belongs to  2 elts:       5     6     0     0     0     0     0     0
V node    27 belongs to  1 elts:       6     0     0     0     0     0     0     0
V node    28 belongs to  1 elts:       6     0     0     0     0     0     0     0
V node    29 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    30 belongs to  1 elts:       4     0     0     0     0     0     0     0
V node    31 belongs to  2 elts:       4     5     0     0     0     0     0     0
V node    32 belongs to  1 elts:       5     0     0     0     0     0     0     0
V node    33 belongs to  2 elts:       5     6     0     0     0     0     0     0
V node    34 belongs to  1 elts:       6     0     0     0     0     0     0     0
V node    35 belongs to  1 elts:       6     0     0     0     0     0     0     0

P node     1 belongs to  1 elts:       1     0     0     0     0     0     0     0
P node     2 belongs to  2 elts:       1     2     0     0     0     0     0     0
P node     3 belongs to  2 elts:       2     3     0     0     0     0     0     0
P node     4 belongs to  1 elts:       3     0     0     0     0     0     0     0
P node     5 belongs to  2 elts:       1     4     0     0     0     0     0     0
P node     6 belongs to  4 elts:       1     2     4     5     0     0     0     0
P node     7 belongs to  4 elts:       2     3     5     6     0     0     0     0
P node     8 belongs to  2 elts:       3     6     0     0     0     0     0     0
P node     9 belongs to  1 elts:       4     0     0     0     0     0     0     0
P node    10 belongs to  2 elts:       4     5     0     0     0     0     0     0
P node    11 belongs to  2 elts:       5     6     0     0     0     0     0     0
P node    12 belongs to  1 elts:       6     0     0     0     0     0     0     0

csrK%NZ=885

node 1 'sees' nodes 1,2,3,8,9,10,15,16,17, so there will be 18 entries on 1st,2nd lines,
node 2 'sees' nodes 1,2,3,8,9,10,15,16,17, so there will be 18 entries on 3rd,4th line,
node 3 'sees' nodes 1,2,3,4,5,8,9,10,11,12,15,16,17,18,19 so there will be 30 entries on 3rd line, etc ...

            
csrK%ia=           1          19          36          52          67          93
                 118         134         149         175         200         216
                 231         245         258         270         281         291
                 300         316         331         341         350         366
                 381         391         400         408         415         433
                 450         466         481         507         532         548
                 563         589         614         630         645         659
                 672         684         695         705         714         730
                 745         755         764         780         795         805
                 814         822         829         835         840         844
                 847         853         858         862         865         871
                 876         880         883         885         886

P node 1   sees V nodes 1 2 3 8 9 10 15 16 17 | 9
P node 2   sees V nodes 1 2 3 4 5 8 9 10 11 12 15 16 17 18 19 | 15
P node 3   sees V nodes 3 4 5 6 7 10 11 12 13 14 17 18 19 20 21 | 15
P node 4   sees V nodes 5 6 7 12 13 14 19 20 21 | 9
P node 5   sees V nodes 1 2 3 8 9 10 15 16 17 22 23 24 29 30 31 | 15
P node 6   sees V nodes 1 2 3 4 5 8 9 10 11 12 15 16 17 18 19 22 23 24 25 26 29 30 31 32 33 | 25
P node 7   sees V nodes 3 4 5 6 7 10 11 12 13 14 17 18 19 20 21 24 25 26 27 28 31 32 33 34 35 | 25
P node 8   sees V nodes 5 6 7 12 13 14 19 20 21 26 27 28 33 34 35 | 15 
P node 9   sees V nodes 15 16 17 22 23 24 29 30 31 | 9
P node 10  sees V nodes 15 16 17 18 19 22 23 24 25 26 29 30 31 32 33 | 15 
P node 11  sees V nodes 17 18 19 20 21 24 25 26 27 28 31 32 33 34 35 | 15
P node 12  sees V nodes 19 20 21 26 27 28 33 34 35 | 9

csrGT%NZ=(4*9+6*15+2*25=36+90+50)*2=176*2=352

\end{verbatim}
\end{small}

















\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The tests}

\input{ELEFANT/TESTS/tests}

















\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The modules and objects}
The whole code is built around a few modules and objects:

\begin{itemize}
\item {\filenamefont module\_parameters.f90}\\
\lstinputlisting[language=Fortran,basicstyle=\tiny]{ELEFANT/module_parameters.f90}

\item {\filenamefont module\_gravity.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_gravity.f90}

\item {\filenamefont module\_materials.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_materials.f90}

\item {\filenamefont module\_mesh.f90}\\
\lstinputlisting[language=Fortran,basicstyle=\tiny]{ELEFANT/module_mesh.f90}

\item {\filenamefont module\_sparse.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_sparse.f90}

\item {\filenamefont module\_statistics.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_statistics.f90}

\item {\filenamefont module\_swarm.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_swarm.f90}

\item {\filenamefont module\_timing.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_timing.f90}

\item {\filenamefont module\_constants.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_constants.f90}

\item {\filenamefont module\_arrays.f90}\\
\lstinputlisting[language=Fortran]{ELEFANT/module_arrays.f90}
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Install MUMPS (Ubuntu)}

\subsection{Sequential install}

Go to the MUMPS website \url{http://mumps.enseeiht.fr/index.php?page=home} and 
fill the form of the Download page. 
Once you have received a link to {\filenamefont MUMPS\_3.X.X.tar.gz}, download
the file and place it in a folder on your computer. Expand it. 
In the terminal place go to the folder, then type:
\begin{verbatim}
> cp Make.inc/Makefile.inc.generic.SEQ Makefile.inc
\end{verbatim}
Edit {\filenamefont Makefile.inc} and replace the C compiler {\tt cc} 
and Fortran compiler {\tt f90} by the names of the compilers on 
your system (in my case {\tt gcc} and {\tt gfortran} respectively).

Then simply make:
\begin{verbatim}
> make 
\end{verbatim}
In the end you should find the following files in the {\tt lib} folder:
\begin{verbatim}
> cd lib
> ls -la
libdmumps.a
libmumps_common.a
libpord.a
\end{verbatim}
Finally copy {\tt libseq/mpif.h} in the \elefant folder.

Edit the Makefile of \elefant to adjust the location of the MUMPS solver.

ADD METIS support


copy dmumps\_struc.h and dmumps\_root.h to main elefant folder.


\subsection{Parallel install}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Setting up an experiment/benchmark/cookbook}

opla

\begin{center}
\input{tikz/tikz_elefant_boundaries}
\end{center}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{To do list}
\input{ELEFANT/todo}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{How to install LAPACK}

\begin{verbatim}
mkdir lapack-Sandbox 
cd lapack-sandbox
git clone https://github.com/Reference-LAPACK/lapack.git
mkdir lapack-build
cd lapack-build
cmake ../lapack
make
\end{verbatim}
You will find in /lib the desired libblas.a and liblapack.a libraries.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The MUMPS solver}

MUMPS stands for MUltifrontal Massively Parallel Solver. It is a software package 
for solving systems of linear equations of the 
form ${\bm A}\cdot{\vec x} = {\vec b}$, where ${\bm A}$ is a square sparse matrix (unsymmetric, 
symmetric positive definite, or general symmetric). 

MUMPS implements a direct method which performs a direct factorisation
${\bm A} = {\bm L}\cdot{\bm U}$ where ${\bm L}$ is a lower triangular matrix and ${\bm U}$ 
an upper triangular matrix. If the matrix is symmetric then the factorisation becomes
${\bm A} = {\bm L}\cdot{\bm D}\cdot{\bm L}^T$
where ${\bm D}$ is a block diagonal matrix. 
All the features of the MUMPS package are documented in the manual available from the 
website\footnote{\url{http://mumps.enseeiht.fr/index.php?page=home}}.

%The main features of the MUMPS package include the solution of the transposed system, 
%input of the matrix in assembled format (distributed or centralized) or elemental format, 
%error analysis, iterative refinement, scaling of the original matrix, out-of-core capability, 
%parallel analysis, detection of null pivots, basic estimate of rank deficiency and null space 
%basis for symmetric matrices and computation of a Schur complement matrix. 

MUMPS offers several built-in ordering algorithms as well as an 
interface to external ordering packages such as PORD \cite{schu01}, SCOTCH \cite{pell07} 
or METIS \cite{kaku98} (used in this study). 
The software is mainly written in Fortran 90 although a C interface is available. 
The parallel version of MUMPS requires 
MPI \cite{snoh96} for message passing and makes use of the BLAS \cite{dodd90a,dodd90b}, BLACS, and ScaLAPACK
\cite{blcc97} libraries. 
The sequential version only relies on BLAS and LAPACK.

The system ${\bm A}\cdot{\vec x} = {\vec b}$ is solved in three main steps:
\begin{itemize}
\item Analysis: preprocessing including an 
ordering based on the symmetrized pattern ${\bm A} + {\bm A}^T$ 
and a symbolic factorisation is performed. 

\item Factorisation: a direct factorisation ${\bm A}_{pre} = {\bm L}\cdot{\bm U}$ 
or ${\bm A}_{pre} = {\bm L}\cdot{\bm D}\cdot {\bm L}^T$ depending on 
the symmetry of the preprocessed matrix is computed. 

\item Solution:
The solution of ${\bm L}\cdot{\bm U}\cdot{\vec x}_{pre} = {\vec b}_{pre}$ 
or ${\bm L}\cdot{\bm D}\cdot{\bm L}^T {\vec x}_{pre} = {\vec b}_{pre}$ (where 
${\vec x}_{pre}$ and ${\vec b}_{pre}$ are respectively the transformed solution 
${\vec x}$ and right-hand side ${\vec b}$ associated to the preprocessed matrix 
${\bm A}_{pre}$), is obtained through a forward elimination step
${\bm L}\cdot{\vec y}={\vec b}_{pre}$ (or ${\bm L}\cdot{\bm D}\cdot{\vec y}={\vec b}_{pre}$), 
followed by a backward elimination step
${\bm U}\cdot{\vec x}_{pre} ={\vec y}$ (or ${\bm L}^T{\vec x}_{pre} ={\vec y}$). 

\end{itemize}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{How we use MUMPS - the elemental format}

What follows is written with $Q_1\times P_0$ elements in mind. 

In two dimensions, the FE grid is composed of $nelx \times nely=nel$ elements. 
The resulting matrix size $N$ is given by $N=(nelx+1)(nely+1)ndofV$ with $ndofV=2$ in 2D.
The connectivity array $icon$ is defined and computed at the beginning for each element. 

The entries $mesh(iel)\%icon(1:4)$ list the nodes making up the element $iel$.
In three dimensions, the grid is naturally composed of 
$nelx \times nely \times nelz = nel$ elements and the 
resulting matrix size is $N=(nelx+1)(nely+1)(nelz+1)ndofV$ with $ndofV=3$.

%------------------------------
\subsection{Allocating arrays}

First, a variable of type {\tt dmumps\_struc} must be declared:
\begin{verbatim}
type(DMUMPS_STRUC) idV 
\end{verbatim}

At the beginning of the program, it is necessary to 
initialise an MPI communicator:

\begin{verbatim}
call mpi_init(ierr)                            
call mpi_comm_size(mpi_comm_world,nproc,ierr) 
call mpi_comm_rank(mpi_comm_world,iproc,ierr) 
\end{verbatim}

Several components of the {\tt idV} variable must then be set and MUMPS 
must be initialised: 
\begin{verbatim}
idV%COMM = MPI_COMM_WORLD 
idV%SYM = 1              
idV%PAR=1                
idV%JOB = -1             
call DMUMPS(idV)        
\end{verbatim}

In the code above
{\tt SYM=1} indicates that the global assembled matrix is symmetric.
{\tt JOB=-1} initializes an instance of the package. 
%Note that a call with 
%{\tt JOB=-1} must be performed before any other call to the package on the same instance. 
%It sets default values for other components of {\tt MUMPS\_STRUC}.
{\tt PAR} must be initialized on all processors and are accessed by MUMPS only during the initialisation phase.
It is here set to 1, i.e. the host is involved in factorisation/solve phases.

In order to solve the FEM problem with MUMPS the user has to declare/build 
a subset of the variables and arrays of {\tt idV} (Note: what follows is only valid in 
the case of an elemental input of the FEM matrix):
\begin{itemize}
\item {\tt idV\%N} is the order of the matrix ${\bm A}$
and {\tt idV\%NELT} is the number of elements being input:
\begin{verbatim}
idV%N=Nfem    
idV%NELT=nel
\end{verbatim}

\item {\tt idV\%ELTPTR} is an integer array of 
length {\tt idV\%NELT+1}. {\tt idV\%ELTPTR(j)} points to the position in {\tt idV\%ELTVAR}
of the first variable in element {\tt j}, and {\tt idV\%ELTPTR(NELT+1)} must be set to 
the position after the last variable of the last element. It is built as follows: 

\begin{lstlisting}
allocate(idV%ELTPTR(idV%NELT+1))
do iel=1,nel                         
   idV%ELTPTR(iel)=1+(iel-1)*(ndofV*mV)   
end do                         
idV%ELTPTR(iel)=1+nel*(ndofV*mV) 
\end{lstlisting}
where $mV=4$ is the number of nodes of the two-dimensional bi-linear $Q_1$ element.

\begin{center}
\includegraphics[width=16cm]{images/MUMPS/grid}\\
{\captionfont Schematic representation of an $8\times4$ FE grid. 
Element 22 is singled out, and is shown to
be composed of 4 nodes: 24, 25, 33 and 34. To the right are shown the corresponding elemental
matrix {\tt K\_el} and right hand side {b\_el}, and where the values will be written in the
{\tt idV\%A\_ELT} and {\tt idV\%RHS} arrays respectively.}
\end{center}


\item {\tt idV\%ELTVAR} is an integer array of length {\tt idV\%ELTPTR(NELT+1)-1} and must 
be set to the lists of variables of the elements. 
Those for element {\tt j} are stored in positions {\tt idV\%ELTPTR(j),..., idV\%ELTPTR(j+1)-1}. 
\begin{verbatim}
LELTVAR=nel*(mV*ndofV)  
allocate(idV%ELTVAR(LELTVAR))
counter=0   
do iel=1,nel 
   do k=1,mV    
      inode=mesh(iel)%icon(k)  
      do idof=1,ndof    
         iii=(inode-1)*ndofV+idof   
         counter=counter+1         
         idV%ELTVAR(counter)=iii   
      end do                   
   end do                 
end do               
\end{verbatim}


\item {\tt idV\%A\_ELT} contains the entries of the elemental matrices stored after one another. Since  
all elemental matrices are symmetric one only needs to store the upper half (including the diagonal terms), 
as shown in green colour in the figure above.
Each elemental matrix contains ({\tt mV*ndofV})$\times$({\tt mV*ndofV}) values but only 
({\tt mV*ndofV})({\tt mV*ndofV+1}){\tt /2} will be stored:
\begin{verbatim}
NA_ELT=nel*(mV*ndofV)*(mV*ndofV+1)/2 
allocate(idV%A_ELT (NA_ELT))
\end{verbatim}

\item {\tt RHS} is a real array containing the assembled right-hand side of the linear system:
\begin{verbatim}
allocate(idV%RHS (idV%N))
\end{verbatim}

\end{itemize}

Note that the above code requires little to no change in the case that higher-order elements are used. 

%==================
\subsection{Assembly}

The host loops over the elements and for each element
the matrix ${\bm K}_{el}$. 
 For each element an elemental matrix {\tt K\_el} and a rhs term {\tt b\_el}
are built. Boundary conditions are then applied, 
and half of {\tt K\_el} is then stored in {\tt A\_ELT} while 
{\tt b\_el} is assembled in the global vector {\tt RHS}.

\begin{verbatim}
counter=0
do iel=1,nel

[build elemental matrices K\_el and Bel]
[impose boundary conditions on K\_el, Bel]

do k1=1,m
   ik=icon(k1,iel)
   do i1=1,ndof
      ikk=ndof*(k1-1)+i1
      m1=ndof*(ik-1)+i1
      do k2=1,m
         do i2=1,ndof
            jkk=ndof*(k2-1)+i2
            if (jkk>=ikk) then
            counter=counter+1
            idV%A_ELT(counter)=K_el(ikk,jkk)
            end if
         end do
      end do
      idV%RHS(m1)=idV%RHS(m1)+Bel(ikk)
   end do
end do

end do
\end{verbatim}




%------------------------------
\subsection{Solving the system}

Once the loop over all elements is completed, {\tt INCTL(5)}
must be set to 1 since the elemental format is being used. 
All three phases of the solve are then carried out. Note that the 
vector {\tt RHS} is overriden by the solution after the solve is completed.   

\begin{verbatim}
id%ICNTL(5) = 1 ! choosing elemental format
id%ICNTL(7) = 5 ! using Metis
id%JOB = 1      ! analysis phase 
CALL DMUMPS(id)
id%JOB = 2      ! factorisation phase 
CALL DMUMPS(id)
id%JOB = 3      ! solve phase
CALL DMUMPS(id)
\end{verbatim}

Finally all arrays of the {\tt idV} structure are deallocated:
\begin{verbatim}
deallocate(idV%A_ELT)
deallocate(idV%RHS)
deallocate(idV%ELTPTR)
deallocate(idV%ELTVAR)
\end{verbatim}


