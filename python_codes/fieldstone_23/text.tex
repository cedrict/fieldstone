\noindent
\includegraphics[height=1.25cm]{images/pictograms/benchmark}
\includegraphics[height=1.25cm]{images/pictograms/msc}
\includegraphics[height=1.25cm]{images/pictograms/FEM}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\lstinputlisting[language=bash,basicstyle=\small]{python_codes/fieldstone_23/keywords.ascii}

\begin{center}
\inpython
{\small Code: \url{https://github.com/cedrict/fieldstone/tree/master/python_codes/fieldstone_23}}
\end{center}

\par\noindent\rule{\textwidth}{0.4pt}

This work is part of the MSc thesis of T. Weir (2018).
\index{contributors}{T. Weir}

\par\noindent\rule{\textwidth}{0.4pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We first start with an isothermal Stokes flow, so that we disregard the heat transport equation and 
the equations we wish to solve are simply:

\begin{align}
-\vec\nabla p +\vec\nabla \cdot \left[2 \eta \left(\dot\varepsilon(\vec \upnu)
            - \frac{1}{3}(\vec\nabla \cdot \vec\upnu) \mathbf 1\right)  \right] +   \rho \vec{g} &=\vec{0}
  &
  & \textrm{in $\Omega$},
  \\
  \vec\nabla \cdot (\rho \vec\upnu) &= 0
  &
  & \textrm{in $\Omega$}
\end{align}



The second equation can be rewritten 
$\vec\nabla \cdot (\rho \vec{\upnu}) =  \rho \vec\nabla \cdot \vec{\upnu} 
+ \vec{\upnu} \cdot \vec{\nabla}\rho=0$
or, 
\[
\vec\nabla \cdot \vec{\upnu} + \frac{1}{\rho} \vec{\upnu} \cdot {\vec\nabla}\rho = 0
\]
Note that this presupposes that the density is not zero anywhere in the domain.

We use a mixed formulation and therefore keep both velocity and pressure as unknowns. 
We end up having to solve the following system:
\[
\left(
\begin{array}{cc}
\K & \G \\ \G^T+\Z & 0 
\end{array}
\right)
\cdot
\left(
\begin{array}{c}
\vec{\cal V} \\ \vec{\cal P}
\end{array}
\right)
=
\left(
\begin{array}{c}
 f \\ h
\end{array}
\right)
\quad\quad
{\rm or,}
\quad\quad
\A \cdot X = \vec{b}
\]
Where $\K$ is the stiffness matrix, $\G$ is the discrete gradient operator, 
$\G^T$ is the discrete divergence operator, $\vec{\cal V}$ the velocity vector, 
$\vec{\cal P}$ the pressure vector.
Note that the term $\Z{\cal V}$ derives from term $\vec{\upnu} \cdot \vec{\nabla}\rho$ 
in the continuity equation. 

Each block $\K$, $\G$ , $\Z$ and vectors $f$ and $h$ are built separately 
in the code and assembled into the matrix $\A$ and vector $\vec{b}$ 
afterwards. $\A$ and $\vec{b}$ are then passed to the solver. 
We will see later that there are alternatives to solve this approach which do not require to 
build the full Stokes matrix $\A$. 

{\sl Remark}: the term $\Z {\cal V}$ is often put in the rhs (i.e. added to $h$) so that 
the matrix $\A$ retains the same structure as in the incompressible case. This is indeed 
how it is implemented in ASPECT. This however requires more work since the rhs depends 
on the solution and some form of iterations is needed. 

In the case of a compressible flow the strain rate tensor and the deviatoric strain 
rate tensor are no more equal (since ${\vec\nabla}\cdot\vec{\upnu} \neq 0$).
The deviatoric strainrate tensor is given by\footnote{See the ASPECT manual for a 
justification of the 3 value in the denominator in 2d and 3d.} 
\[
\dot{\bm \varepsilon}^d(\vec{\upnu})=
\dot{\bm \varepsilon}(\vec{\upnu})-\frac{1}{3} Tr(\dot{\bm \varepsilon}) {\bm 1}
=\dot{\bm \varepsilon}(\vec{\upnu})-\frac{1}{3} ({\bm \nabla}\cdot \vec{\upnu}) {\bm 1}
\]
In that case:
\begin{eqnarray}
\dot{\varepsilon}_{xx}^d 
&=& \frac{\partial u}{\partial x}
-\frac{1}{3} \left( \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} \right) 
= \frac{2}{3}\frac{\partial u}{\partial x}
-\frac{1}{3} \frac{\partial v}{\partial y}
%=
%\frac{2}{3} \sum_{i=1}^4 \frac{\partial N_i}{\partial x}\;  u_i 
%-\frac{1}{3} \sum_{i=1}^4 \frac{\partial N_i}{\partial y}\;  v_i 
\\
\dot{\varepsilon}_{yy}^d 
&=& \frac{\partial v}{\partial y}
-\frac{1}{3} \left( \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} \right) 
=-\frac{1}{3} \frac{\partial u}{\partial x} 
+ \frac{2}{3} \frac{\partial v}{\partial y} 
%=-\frac{1}{3}  \sum_{i=1}^4 \frac{\partial N_i}{\partial x}\;  u_i
%+ \frac{2}{3} \sum_{i=1}^4 \frac{\partial N_i}{\partial y}\;  v_i
\\
2\dot{\varepsilon}_{xy}^d 
&=& 
\frac{\partial u}{\partial y} 
+\frac{\partial v}{\partial x} 
%= \sum_{i=1}^4 \frac{\partial N_i}{\partial y}\;  u_i
%+ \sum_{i=1}^4 \frac{\partial N_i}{\partial x}\;  v_i
\end{eqnarray}
and then 
\[
\dot{\bm \varepsilon}^d({\bm v})
=
\left(
\begin{array}{cc}
\frac{2}{3} \frac{\partial u}{\partial x} -\frac{1}{3} \frac{\partial v}{\partial y} &
\frac{1}{2}\frac{\partial u}{\partial y} + \frac{1}{2}\frac{\partial v}{\partial x}  \\ \\
\frac{1}{2}\frac{\partial u}{\partial y} + \frac{1}{2}\frac{\partial v}{\partial x}  &
-\frac{1}{3} \frac{\partial u}{\partial x} +\frac{2}{3} \frac{\partial v}{\partial y} 
\end{array}
\right)
\]

From $\vec{\tau} = 2\eta \vec{\epsilon}^d$ we arrive at:
\[
\left(
\begin{array}{c}
\tau_{xx}\\
\tau_{yy}\\
\tau_{xy}\\
\end{array}
\right)
=
2\eta
\left(
\begin{array}{c}
\dot{\epsilon}_{xx}^d \\
\dot{\epsilon}_{yy}^d \\
\dot{\epsilon}_{xy}^d 
\end{array}
\right)
=2 \eta
\left(
\begin{array}{ccc}
2/3 & -1/3& 0 \\
-1/3 & 2/3 & 0 \\
0 & 0 & 1/2 \\
\end{array}
\right)
\cdot 
\left(
\begin{array}{c}
\frac{\partial u}{\partial x} \\ 
\frac{\partial v}{\partial y} \\ 
\frac{\partial u}{\partial y}\! +\! \frac{\partial v}{\partial x} \\
\end{array}
\right)
=
\eta
\left(
\begin{array}{ccc}
4/3 & -2/3& 0 \\
-2/3 & 4/3 & 0 \\
0 & 0 & 1 \\
\end{array}
\right)
\cdot 
\left(
\begin{array}{c}
\frac{\partial u}{\partial x} \\ 
\frac{\partial v}{\partial y} \\ 
\frac{\partial u}{\partial y}\! +\! \frac{\partial v}{\partial x} \\
\end{array}
\right)
\]
or, 
\[
\vec{\tau} = {\bm C}_\eta {\bm B} V
\]







\newpage
In order to test our implementation we have created a few manufactured solutions:
\begin{itemize}
\item \underline{benchmark \#1} ({\tt ibench=1})): Starting from a density profile of:
\begin{equation}
    \rho(x,y) = xy
\end{equation}
We derive a velocity given by:
\begin{equation}
    v_x(x,y) = \frac{C_x}{x} , v_y(x,y) = \frac{C_y}{y}
\end{equation}

With $g_x(x,y) = \frac{1}{x}$ and $g_y(x,y) = \frac{1}{y}$, this leads us to a pressure profile:
\begin{equation}
    p = - \eta \left( \frac{4C_x}{3x^2} + \frac{4C_y}{3y^2} \right)  + xy + C_0
\end{equation}
This gives us a strain rate:
\[
\dot{\epsilon}_{xx} =  \frac{-C_x}{x^2}
\quad
\quad
\quad
\dot{\epsilon}_{yy} =  \frac{-C_y}{y^2}
\quad
\quad
\quad
\dot{\epsilon}_{xy} = 0 
\]
In what follows, we choose $\eta=1$ and $C_x=C_y=1$ and for a unit square domain $
[1:2]\times[1:2]$ we compute $C_0$
so that the pressure is normalised to zero over the whole domain and obtain $C_0=-1$. 
 
\item \underline{benchmark \#2} ({\tt ibench=2}): Starting from a density profile of:
\begin{equation}
    \rho = \cos(x)\cos(y)
\end{equation}
We derive a velocity given by:
\begin{equation}
    v_x = \frac{C_x}{\cos(x)} , v_y = \frac{C_y}{\cos(y)}
\end{equation}
With $g_x = \frac{1}{\cos(y)}$ and $g_y = \frac{1}{\cos(x)}$, this leads us to a pressure profile:
\begin{equation}
    p =  \eta \Bigg(\frac{4C_x \sin(x)}{3\cos^2(x)} + \frac{4C_y \sin(y)}{3\cos^2(y)}\Bigg) 
    +( \sin(x) + \sin(y) ) + C_0
\end{equation}
\[
\dot{\epsilon}_{xx} = C_x \frac{\sin(x)}{\cos^2(x)}
\quad
\quad
\quad
\dot{\epsilon}_{yy} = C_y \frac{\sin(y)}{\cos^2(y)}
\quad
\quad
\quad
\dot{\epsilon}_{xy} = 0 
\]
We choose $\eta=1$ and $C_x=C_y=1$. The domain is the unit square $[0:1]\times[0:1]$ and we obtain 
$C_0$ as before and obtain 
\[
C_0 = 2 - 2 \cos(1) + 8/3 (\frac{1}{\cos (1)} - 1)
\simeq 3.18823730
\]
(thank you WolframAlpha)


\item \underline{benchmark \#3} ({\tt ibench=3}) 
\item \underline{benchmark \#4} ({\tt ibench=4}) 
\item \underline{benchmark \#5} ({\tt ibench=5}) 
\end{itemize}





%\includegraphics[width=16cm]{python_codes/fieldstone_saddlepoint/solution.pdf}

ToDo:
\begin{itemize}
\item pbs with odd vs even number of elements 
\item q is 'fine' everywhere except in the corners - revisit pressure smoothing paper?
\item redo A v d Berg benchmark (see Tom Weir thesis)
\end{itemize}



\newpage
\section*{Analytical solution}


We start from 
\[
\rho(x,y)=xy
\qquad
u(x,y)=\frac{C_x}{x}
\qquad
v(x,y)=\frac{C_y}{y}
\qquad
g_x(x,y)=\frac{1}{x}
\qquad
g_y(x,y)=\frac{1}{y}
\]
We then confirm that 
\[
\vec\nabla \cdot (\rho \vec\upnu) 
= \rho \vec\nabla \cdot \vec\upnu
+ \vec\upnu \cdot \vec\nabla \rho
= xy \left(\frac{\partial u}{\partial x}+\frac{\partial v}{\partial y} \right)
+ \frac{C_x}{x} \frac{\partial \rho}{\partial x}
+ \frac{C_y}{y} \frac{\partial \rho}{\partial y}
= xy \left( -\frac{C_x}{x^2} - \frac{C_y}{y^2}  \right)
+ \frac{C_x y}{x} + \frac{C_y x}{y}=0
\]
From the definition of the velocity we can compute the strain rate and deviatoric strain rate tensors:

\begin{eqnarray}
\dot{\bm \varepsilon} 
&=& 
\begin{pmatrix}
-C_x/x^ 2 & 0 \\
0 & -C_y/y^2
\end{pmatrix} \nn\\
\dot{\bm \varepsilon}^d 
&=& \dot{\bm \varepsilon} -\frac13  \vec\nabla \cdot \vec\upnu {\bm 1} \nn\\
&=& \dot{\bm \varepsilon} -\frac13  \left( -\frac{C_x}{x^2} - \frac{C_y}{y^2} \right) {\bm 1} \nn\\
&=&\dot{\bm \varepsilon} +\frac13  \left( \frac{C_x}{x^2} + \frac{C_y}{y^2}  \right) {\bm 1} \nn\\
&=&
\begin{pmatrix}
-\frac{2C_x}{3x^2} + \frac{C_y}{3y^2} & 0 \\
0 & \frac{C_x}{3x^2} - \frac{2C_y}{3y^2}
\end{pmatrix} \nn
\end{eqnarray}
Assuming the viscosity to be constant, the moment conservation equation is then
\begin{eqnarray}
\vec{0}&=& -\vec\nabla p + \vec\nabla \cdot (2 \eta \dot{\bm \varepsilon}^d )+ \rho \vec{g} \nn\\
&=& 
\begin{pmatrix} 
-\frac{\partial p}{\partial x} \\
-\frac{\partial p}{\partial y} 
\end{pmatrix} 
+  2 \eta \vec\nabla \cdot   
\begin{pmatrix}
-\frac{2C_x}{3x^2} + \frac{C_y}{3y^2} & 0 \\
0 & \frac{C_x}{3x^2} - \frac{2C_y}{3y^2}
\end{pmatrix}
+ 
\begin{pmatrix}
y \\x
\end{pmatrix} \nn\\
&=&
\begin{pmatrix} 
-\frac{\partial p}{\partial x} + 2\eta \frac{\partial}{\partial x} (-\frac{2C_x}{3x^2} +\frac{C_y}{3y^2})+ y \\
-\frac{\partial p}{\partial y} + 2\eta \frac{\partial}{\partial y} (\frac{C_x}{3x^2} -\frac{2C_y}{3y^2})+ x 
\end{pmatrix} \nn\\
&=& 
\begin{pmatrix} 
-\frac{\partial p}{\partial x} + 2\eta \frac{\partial}{\partial x} (-\frac{2C_x}{3x^2} )+ y \\
-\frac{\partial p}{\partial y} + 2\eta \frac{\partial}{\partial y} (-\frac{2C_y}{3y^2})+ x 
\end{pmatrix} 
\end{eqnarray}
The first line leads to write 
\[
p(x,y) = -\frac{4 \eta C_x}{3x^2}   + yx + f(y)
\]
Inserting this in the second line:
\[
-\frac{\partial }{\partial y}  \left( -\frac{4 \eta C_x}{3x^2}   + yx + f(y) \right) 
+ 2\eta \frac{\partial}{\partial y} \left(-\frac{2C_y}{3y^2} \right)+ x = 0
\]
\[
-x - f'(y) + 2\eta \frac{\partial}{\partial y} \left(-\frac{2C_y}{3y^2} \right)+ x = 0
\]
or, 
\[
f(y) =   -\frac{4 \eta C_y}{3y^2} + Const
\]
and finally
\[
p(x,y) =  -\frac{4 \eta C_x}{3x^2}  -\frac{4 \eta C_y}{3y^2}   + yx    + Const 
\]
Requiring $\iint_\square p \; dxdy=0$ where $\square=[1:2]\times [1:2]$ (because of the 
expressions for velocity and gravity the origin of the axis system cannot be included in the 
domain) leads to 
\begin{eqnarray}
\iint_\square  
\left( -\frac{4 \eta C_x}{3x^2}  -\frac{4 \eta C_y}{3y^2}   + yx    + Const \right) 
&=& 
\iint_\square   \left( -\frac{4 \eta C_x}{3x^2}  -\frac{4 \eta C_y}{3y^2}   + yx  \right) dxdy
+\iint_\square   Const \; dx dy \nn\\
&=&\iint_\square   \left( -\frac{4 \eta C_x}{3x^2}  -\frac{4 \eta C_y}{3y^2}   + yx  \right) dxdy
+ Const
\end{eqnarray}
so that 
\[
Const = -\int_1^2 \int_1^2  \left( -\frac{4 \eta C_x}{3x^2}  -\frac{4 \eta C_y}{3y^2}   + yx  \right) dxdy
\]
We then set $\eta=C_x=C_y=1$ for simplicity so that we find\footnote{Thank you WolframAlpha}:
\[
Const= -11/12
\]
and in the end
\[
p(x,y) = -\frac{4}{3x^2} -\frac{4}{3y^2} + yx -\frac{11}{12}
\]

